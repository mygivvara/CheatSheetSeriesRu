# Шпаргалка по выбору и использованию контрольных вопросов

## Введение

**ВНИМАНИЕ: контрольные вопросы больше не считаются допустимым фактором аутентификации в соответствии с [NIST SP 800-63](https://pages.nist.gov/800-63-3/sp800-63b.html). Восстановление учетной записи — это просто альтернативный способ аутентификации, поэтому он не должен быть слабее обычной аутентификации. См. [SP 800-63B секц. 5.1.1.2 параграф 4](https://pages.nist.gov/800-63-3/sp800-63b.html#sec5): *Подтверждающие службы НЕ ДОЛЖНЫ предлагать подписчикам использовать определенные типы информации (например, «Как зовут вашего первого питомца?») при выборе запоминаемых секретов*.**

Если вам интересно, ознакомьтесь с этим [исследованием](https://www.microsoft.com/en-us/research/publication/its-no-secret-measuring-the-security-and-reliability-of-authentication-via-secret-questions/) , проведенным Microsoft Research в 2009 году, и этим [исследованием](https://research.google/pubs/pub43783/), выполненным в Google в 2015 году. Сопутствующее обновление в [блоге безопасности](https://security.googleblog.com/2015/05/new-research-some-tough-questions-for.html) включает инфографику по вопросам, связанным с контрольными вопросами.

**Обратите внимание:** Хотя контрольные вопросы больше не рекомендуются для использования в безопасных программах, эта шпаргалка предоставляет рекомендации по выбору надежных контрольных вопросов для использования в старых системах.

## Выбор контрольных вопросов

### Желаемые характеристики

Любые контрольные вопросы, представленные пользователям для сброса забытых паролей, должны соответствовать следующим характеристикам:

| Характеристика | Описание |
|----------------|-------------|
| Легко запоминаемый | Пользователь должен иметь возможность вспомнить ответ на вопрос, возможно, через годы после создания учетной записи. |
| Постоянный | Ответ на вопрос не должен меняться со временем. |
| Применимый | Пользователь должен быть в состоянии ответить на вопрос.
| Конфиденциальный | Ответ на вопрос должен быть сложным для получения злоумышленником. |
| Точный | Ответ должен быть понятен пользователю. |

### Типы контрольных вопросов

Контрольные вопросы делятся на два основных типа. С *пользовательскими* контрольными вопросами пользователь должен выбрать вопрос из списка и дать ответ на него. Общие примеры включают "Какой ваш любимый цвет?" или "Какой у вас был первый автомобиль?".

Такие вопросы легко реализовать в приложениях, так как дополнительная информация предоставляется пользователем при первом создании учетной записи. Однако пользователи часто выбирают слабые или легко угадываемые ответы на эти вопросы.

*Системные* контрольные вопросы основаны на информации, уже известной о пользователе. Такой подход позволяет избежать необходимости запрашивать у пользователя конкретные контрольные вопросы и ответы, а также предотвращает возможность выбора слабых данных. Однако он зависит от того, что уже хранится достаточное количество информации о пользователе и что эта информация сложна для получения злоумышленником.

### Пользовательские контрольные вопросы

#### Плохие вопросы

Следует избегать любых вопросов, которые не обладают всеми обсуждаемыми выше характеристиками. В таблице ниже приведены некоторые примеры плохих контрольных вопросов:

| Вопрос | Проблема |
|----------|---------|
| Когда ваш день рождения? | Легко узнать злоумышленнику. | 
| Какая ваша запоминающаяся дата? | Большинство пользователей просто введут свой день рождения. |
| Какой ваш любимый фильм? | Вероятно, меняется со временем. |
| Какой ваш любимый крикетный клуб? | Не подходит для большинства пользователей. |
| Какой маркой и моделью был ваш первый автомобиль? | Довольно небольшой диапазон возможных ответов. |
| Как вас называют друзья? | Можно догадаться, просто просматривая сообщения в социальных сетях. |

Кроме того, следует учитывать контекст приложения при решении, хорошие или плохие вопросы. Например, вопрос типа "Какая была фамилия вашего учителя математики в 8 классе?" было бы легко угадать, если бы он использовался в виртуальной учебной среде вашей школы (так как другие ученики, вероятно, знают эту информацию), но был бы намного сильнее для веб-сайта онлайн-игр.

#### Хорошие вопросы

Многие хорошие контрольные вопросы не подходят всем пользователям, поэтому лучший подход — предложить пользователю выбрать из списка контрольных вопросов. Это позволяет использовать более конкретные вопросы (с более безопасными ответами), при этом предоставляя каждому пользователю вопросы, на которые они могут ответить.

Ниже приведены примеры хороших вопросов:

- Какое учебное заведение вы подавали заявку, но не посещали?
- Какое название первой школы, в которую вы ходили?
- Каково было направление вашей самой запоминающейся школьной поездки?
- Какова была фамилия вашего учителя математики в 8 классе?
- Какое имя было у вашей первой мягкой игрушки?
- Какое имя было у вашего инструктора по вождению?

Как и в случае с паролями, существует риск того, что пользователи будут использовать одни и те же вопросы для восстановления между различными сайтами, что может подвергнуть пользователей риску, если другой сайт будет скомпрометирован. Таким образом, есть преимущества в использовании уникальных контрольных вопросов, которые вряд ли будут использоваться между сайтами. Легкий способ добиться этого — создать более целенаправленные вопросы в зависимости от типа приложения. Например, на платформе торговли акциями могут использоваться финансовые вопросы, такие как "В какой компании вы впервые купили акции?"

#### Разрешение пользователям создавать свои собственные вопросы

Разрешение пользователям создавать свои собственные контрольные вопросы может привести к тому, что они выберут очень сильные и уникальные вопросы, которые будет трудно угадать злоумышленнику. Однако существует также значительный риск, что пользователи выберут слабые вопросы. В некоторых случаях пользователи могут даже установить контрольный вопрос в качестве напоминания о своем пароле, что позволит любому, угадавшему их адрес электронной почты, взломать их учетную запись.

Таким образом, обычно лучше не позволять пользователям создавать свои собственные вопросы.

#### Ограничение ответов

Принудительное соблюдение минимальной длины ответов может предотвратить ввод пользователями строк, таких как "a" или "123" в качестве ответов. Однако, в зависимости от заданных вопросов, это также может помешать пользователям правильно ответить на вопрос. Например, вопрос о первом имени или фамилии может привести к двухбуквенному ответу, такому как "Ли", а вопрос на основе цвета — к пятибуквенному, например, "синий".

Ответы также следует проверять по запретному списку, который включает:

- Имя пользователя или адрес электронной почты.
- Текущий пароль пользователя.
- Частые строки, такие как "123" или "пароль".

#### Обновление контрольных вопросов

Если контрольные вопросы не используются в качестве основной аутентификации, то следует периодически (например, при изменении паролей после их истечения) предлагать пользователю просмотреть свои контрольные вопросы и убедиться, что они по-прежнему помнят ответы. Это должно дать им возможность обновить любые ответы, которые могли измениться (хотя в идеале этого не должно происходить с хорошими вопросами), и увеличить вероятность того, что они вспомнят их, если когда-нибудь потребуется восстановить учетную запись.

### Системные контрольные вопросы

Системные контрольные вопросы основаны на информации, которая уже известна о пользователе. Часто используются личные данные пользователей, включая полное имя, адрес и дату рождения. Однако злоумышленник может легко получить их через социальные сети, и поэтому они предоставляют очень слабый уровень аутентификации.

Вопросы, которые можно использовать, будут сильно различаться в зависимости от приложения и от того, сколько информации уже хранится о пользователе. При принятии решения о том, какие данные можно использовать для контрольных вопросов, следует учитывать следующие факторы:

- Сможет ли пользователь вспомнить ответ на вопрос?
- Может ли злоумышленник легко получить эту информацию из социальных сетей или других источников?
- Одинаков ли ответ для большого числа пользователей или его легко угадать?

## Использование контрольных вопросов

### Когда использовать контрольные вопросы
Приложения обычно должны использовать пароль вместе со вторым фактором аутентификации (например, одноразовым паролем, OTP) для аутентификации пользователей. Комбинация пароля и контрольных вопросов **не является многофакторной аутентификацией (MFA)**, так как оба фактора относятся к одному и тому же типу (т.е. "что-то, что вы знаете").

**Контрольные вопросы не должны использоваться в качестве единственного механизма для аутентификации пользователя**. Однако они могут обеспечить полезный дополнительный уровень безопасности, когда другие более сильные факторы недоступны. Общие случаи их использования включают:

- Вход в систему.
- Сброс забытого пароля.
- Сброс потерянного MFA-токена.

#### Поток аутентификации

Контрольные вопросы могут использоваться как часть основного процесса аутентификации для дополнения паролей в случаях, когда MFA недоступен. Типичный поток аутентификации может выглядеть следующим образом:

- Пользователь вводит свое имя пользователя и пароль.
- Если имя пользователя и пароль правильные, пользователю предлагаются контрольные вопросы.
- Если ответы верны, пользователь входит в систему.

Если ответы на контрольные вопросы неверны, это должно считаться неудачной попыткой входа, и счетчик блокировки учетной записи для пользователя должен быть увеличен.

#### Поток восстановления забытого пароля или утерянного MFA-токена

Функционал восстановления пароля часто предоставляет механизм для атаки путем перечисления учетных записей пользователей, если он реализован неправильно. Следующий поток предотвращает эту проблему, отображая контрольные вопросы только после того, как пользователь докажет владение электронной почтой:

- Пользователь вводит адрес электронной почты (и решает CAPTCHA).
- Приложение отображает общее сообщение, например: "Если адрес электронной почты был правильным, на него будет отправлено письмо".
- Пользователю отправляется письмо с случайно сгенерированной одноразовой ссылкой.
- Пользователь нажимает на ссылку.
- Пользователю предлагаются контрольные вопросы.
- Если ответ верен, пользователь может ввести новый пароль.

### Как использовать контрольные вопросы

#### Хранение ответов

Ответы на контрольные вопросы могут содержать личную информацию о пользователе и могут также использоваться пользователем в других приложениях. Поэтому их следует обрабатывать так же, как и пароли, и хранить с использованием безопасного алгоритма хеширования, такого как Bcrypt. Дополнительные рекомендации можно найти в [шпаргалке по хранению паролей](Password_Storage_Cheat_Sheet.md) contains further guidance on this.

#### Сравнение ответов

Сравнение ответов, предоставленных пользователем, с сохраненными ответами в регистронезависимом режиме облегчает задачу пользователю. Самый простой способ сделать это — привести ответ к нижнему регистру перед его хешированием и хранением, а затем также преобразовать ответ пользователя в нижний регистр перед сравнением.

Также полезно дать пользователю представление о формате, который он должен использовать при вводе ответов. Это можно сделать с помощью валидации ввода или просто рекомендуя пользователю вводить свои данные в определенном формате. Например, при запросе даты указание формата "ДД/ММ/ГГГГ" поможет пользователю не гадать, в каком формате он ввел данные при регистрации.

#### Обновление ответов

Когда пользователь обновляет ответы на свои контрольные вопросы, это следует рассматривать как чувствительную операцию в приложении. Поэтому пользователю следует потребовать повторной аутентификации путем ввода пароля (или, в идеале, с использованием MFA), чтобы предотвратить возможность обновления вопросов злоумышленником при временном доступе к учетной записи пользователя.

#### Несколько контрольных вопросов

Когда используются контрольные вопросы, пользователю может быть задан один вопрос или несколько вопросов одновременно. Это обеспечивает более высокий уровень уверенности, особенно если вопросы разнообразны, так как злоумышленнику потребуется получить больше информации о целевом пользователе. Смешение вопросов, определяемых пользователем, и системных вопросов может быть очень эффективным.

Если пользователю задается один вопрос из возможных, то этот вопрос **не должен** изменяться до тех пор, пока пользователь не ответит на него правильно. Если злоумышленнику будет позволено попытаться ответить на все различные контрольные вопросы, это значительно увеличит вероятность того, что он сможет угадать или получить ответ на один из них.

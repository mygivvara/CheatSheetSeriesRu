# Шпаргалка по управлению ключами

## Введение

Эта шпаргалка по управлению ключами предоставляет разработчикам рекомендации по реализации управления криптографическими ключами в приложении безопасным образом. Важно документировать и согласовывать правила и практики для:

1. Управления жизненным циклом ключей (создание, распределение, уничтожение)
2. Компрометации ключей, восстановления и их аннулирования
3. Хранения ключей
4. Согласования ключей

## Общие рекомендации и соображения

Сформулируйте план общей криптографической стратегии организации, чтобы направлять разработчиков, работающих над различными приложениями, и обеспечить соответствие криптографических возможностей каждого приложения минимальным требованиям и лучшим практикам.

Определите криптографические и управленческие требования для вашего приложения и картируйте все компоненты, которые обрабатывают или хранят криптографические ключи.

## Выбор ключей

Выбор криптографических и управленческих алгоритмов для использования в данном приложении должен начинаться с понимания целей приложения.

Например, если от приложения требуется безопасное хранение данных, разработчику следует выбрать набор алгоритмов, поддерживающих цель защиты данных в покое. Приложения, требующие передачи и получения данных, должны выбрать набор алгоритмов, поддерживающих цель защиты данных в транзите.

Мы предоставили рекомендации по выбору криптографических наборов для приложения на основе его целей и требований безопасности. Разработчики приложений часто начинают разработку криптографических и управленческих возможностей, исследуя доступные библиотеки.

Однако следует провести анализ реальных потребностей приложения, чтобы определить оптимальный подход к управлению ключами. Начните с понимания целей безопасности приложения, которые затем определят выбор наиболее подходящих криптографических протоколов. Например, приложение может требовать:

1. Конфиденциальности данных в покое и конфиденциальности данных в транзите.
2. Аутентичности конечного устройства.
3. Аутентичности происхождения данных.
4. Целостности данных в транзите.
5. Ключей для создания ключей шифрования данных.

Как только понимание потребностей в безопасности приложения будет достигнуто, разработчики смогут определить необходимые протоколы и алгоритмы. После понимания протоколов и алгоритмов вы можете начать определение различных типов ключей, которые будут поддерживать цели приложения.

Существует множество типов ключей и сертификатов, которые следует учитывать, например:

1. **Шифрование:** симметричные ключи шифрования, асимметричные ключи шифрования (публичные и частные).
2. **Аутентификация конечных устройств:** предварительно согласованные симметричные ключи, доверенные сертификаты, точки доверия.
3. **Аутентификация происхождения данных:** HMAC.
4. **Защита целостности:** коды аутентификации сообщений (MAC).
5. **Ключи шифрования ключей**.

### Алгоритмы и Протоколы

Согласно `NIST SP 800-57 Часть 1`, многие алгоритмы и схемы, предоставляющие услуги безопасности, используют [хеш-функцию](https://en.wikipedia.org/wiki/Hash_function) как компонент алгоритма.

Хеш-функции можно найти в алгоритмах цифровых подписей (`FIPS186`), в кодах аутентификации сообщений с использованием ключа (HMAC) (`FIPS198`), в функциях/методах генерации ключей (`NIST Special Publications (SP) 800-56A, 800-56B, 800-56C и 800-108`) и в генераторах случайных чисел (`NIST SP 800-90A`). Одобренные хеш-функции определены в `FIPS180`.

`NIST SP 800-57 Часть 1` выделяет три основные категории одобренных криптографических алгоритмов: хеш-функции, симметричные алгоритмы и асимметричные алгоритмы. Классы определяются количеством криптографических ключей, используемых в сочетании с алгоритмом.

NSA опубликовала отчет, [Commercial National Security Algorithm Suite 2.0](https://media.defense.gov/2022/Sep/07/2003071834/-1/-1/0/CSA_CNSA_2.0_ALGORITHMS_.PDF), в котором перечислены криптографические алгоритмы, которые должны оставаться надежными даже с развитием квантовых вычислений.

#### Криптографические хеш-функции

Криптографические хеш-функции не требуют ключей. Хеш-функции создают относительно короткий дайджест (хеш-значение) из (возможно) большого входного значения таким образом, что в принципе трудно обратить процесс (т.е. сложно найти входное значение, которое даст заданный выход). Хеш-функции используются как строительные блоки для управления ключами, например,

1. Для предоставления услуг аутентификации и целостности данных (Раздел 4.2.3) – хеш-функция используется с ключом для генерации кода аутентификации сообщения.
2. Для сжатия сообщений для генерации и проверки цифровой подписи (Раздел 4.2.4).
3. Для генерации ключей в алгоритмах установления ключей (Раздел 4.2.5).
4. Для генерации детерминированных случайных чисел (Раздел 4.2.7).

#### Симметричные алгоритмы

Симметричные алгоритмы (иногда называемые алгоритмами с секретным ключом) преобразуют данные таким образом, что в принципе сложно выполнить обратное преобразование без знания секретного ключа. Ключ называется "симметричным", потому что один и тот же ключ используется для криптографической операции и её обратного действия (например, шифрование и дешифрование).

Симметричные ключи часто известны более чем одной стороне; однако ключ не должен быть раскрыт сторонам, не имеющим разрешения на доступ к данным, защищенным этим алгоритмом и ключом. Симметричные алгоритмы используются, например,

1. Для обеспечения конфиденциальности данных (Раздел 4.2.2); один и тот же ключ используется для шифрования и дешифрования данных.
2. Для предоставления услуг аутентификации и целостности (Раздел 4.2.3) в форме кодов аутентификации сообщений (MAC); один и тот же ключ используется для генерации MAC и его проверки. MAC обычно используют либо симметричный ключевой алгоритм шифрования, либо криптографическую хеш-функцию в качестве их криптографического примитива.
3. Как часть процесса установления ключей (Раздел 4.2.5).
4. Для генерации детерминированных случайных чисел (Раздел 4.2.7).

#### Асимметричные алгоритмы

Асимметричные алгоритмы, обычно известные как алгоритмы с открытым ключом, используют две связанные ключа (т.е. пару ключей) для выполнения своих функций: открытый ключ и закрытый ключ. Открытый ключ может быть известен любому, в то время как закрытый ключ должен находиться под исключительным контролем того, кто "владеет" парой ключей. Несмотря на то что открытый и закрытый ключи пары связаны, знание открытого ключа не раскрывает закрытый ключ. Асимметричные алгоритмы используются, например,

1. Для вычисления цифровых подписей (Раздел 4.2.4).
2. Для установления криптографических ключевых материалов (Раздел 4.2.5).
3. Для генерации случайных чисел (Раздел 4.2.7).

#### Коды Аутентификации Сообщений (MAC)

Коды аутентификации сообщений (MAC) обеспечивают аутентификацию данных и их целостность. MAC — это криптографическая контрольная сумма данных, используемая для гарантии того, что данные не были изменены и что MAC был вычислен ожидаемым субъектом.

Хотя целостность сообщений часто обеспечивается с помощью некриптографических методов, известных как коды обнаружения ошибок, эти коды могут быть изменены злоумышленником для получения выгоды. Использование одобренного криптографического механизма, такого как MAC, может решить эту проблему.

Кроме того, MAC может обеспечить получателя гарантией того, что отправитель данных является обладателем ключа (т.е. субъектом, уполномоченным иметь ключ). MAC часто используются для аутентификации отправителя у получателя, когда только эти две стороны разделяют ключ MAC.

#### Цифровые Подписи

[Цифровые подписи](https://en.wikipedia.org/wiki/Digital_signature) используются для обеспечения аутентификации, целостности и [неопровержимости](https://en.wikipedia.org/wiki/Non-repudiation). Цифровые подписи используются вместе с хеш-функциями и вычисляются для данных любой длины (до предела, определенного хеш-функцией).

`FIPS186` определяет алгоритмы, одобренные для вычисления цифровых подписей.

#### Ключи для Шифрования Ключей

Симметричные ключи обертывания используются для шифрования других ключей с помощью симметричных алгоритмов шифрования. Ключи обертывания также известны как ключи шифрования ключей.

### Сила Ключей

Просмотрите `NIST SP 800-57` (Рекомендации по управлению ключами) для получения рекомендаций по силе ключей для конкретных реализаций алгоритмов. Также учитывайте следующие лучшие практики:

1. Установите, какое минимальное сопротивление атакам должно быть у приложения. Понимание минимального сопротивления атакам должно учитывать сложность ваших противников, как долго данные должны быть защищены, где данные хранятся и если они подвергаются воздействию. Определение сопротивления атакам поможет инженерам понять минимальную длину криптографического ключа, необходимого для защиты данных в течение их срока службы. Консультируйтесь с `NIST SP 800-131a` для получения дополнительной информации о определении соответствующих длин ключей для выбранного алгоритма.
2. При шифровании ключей для хранения или распределения всегда шифруйте криптографический ключ другим ключом равной или большей криптографической силы.
3. При переходе к [алгоритмам на основе эллиптических кривых](https://en.wikipedia.org/wiki/Elliptic-curve_cryptography) выбирайте длину ключа, которая соответствует или превосходит сравнительную силу других алгоритмов, используемых в вашей системе. Смотрите `NIST SP 800-57 Таблица 2`.
4. Сформулируйте стратегию для общей криптографической стратегии организации, чтобы направлять разработчиков, работающих над различными приложениями, и обеспечить, чтобы криптографические возможности каждого приложения соответствовали минимальным требованиям и лучшим практикам.

### Соображения по Управлению Памятью

Ключи, хранящиеся в памяти длительное время, могут стать "вмонтированными" или "впаянными". Это можно смягчить, разделив ключ на компоненты, которые часто обновляются. (`NIST SP 800-57`).

Потеря или повреждение носителя памяти, на котором хранятся ключи и/или сертификаты, и планирование восстановления, согласно `NIST SP 800-57`.

Планируйте восстановление после возможного повреждения носителя памяти, необходимого для генерации ключей или сертификатов, регистрации и/или распределительных систем, подсистем или компонентов, как рекомендовано в `NIST SP 800-57`.

### Идеальная Прямолинейная Секретность

[Эфемерные ключи](https://en.wikipedia.org/wiki/Ephemeral_key) могут обеспечить идеальную прямолинейную секретность, что означает, что компрометация долгосрочного подписи сервера не ставит под угрозу конфиденциальность прошлых сеансов. Смотрите [шпаргалку по TLS](Transport_Layer_Security_Cheat_Sheet.md).

### Использование Ключей

Согласно NIST, в общем случае один ключ должен использоваться только для одной цели (например, шифрование, аутентификация, обертывание ключей, генерация случайных чисел или цифровые подписи).

Есть несколько причин для этого:

1. Использование одного и того же ключа для двух разных криптографических процессов может ослабить безопасность, предоставляемую одним или обоими процессами.
2. Ограничение использования ключа ограничивает ущерб, который может быть нанесен в случае компрометации ключа.
3. Некоторые использования ключей могут мешать друг другу. Например, время, на которое ключ может понадобиться для каждого использования и цели. Требования по удержанию данных могут различаться для разных типов данных.

### Темы Криптографического Модуля

Согласно `NIST SP 800-133`, криптографические модули — это набор аппаратного обеспечения, программного обеспечения и/или прошивки, который реализует функции безопасности (включая криптографические алгоритмы и генерацию ключей) и содержится в границах криптографического модуля для обеспечения защиты ключей.

## Лучшие Практики Управления Жизненным Циклом Ключей

### Генерация

Криптографические ключи должны быть сгенерированы внутри криптографического модуля, соответствующего требованиям хотя бы `FIPS 140-2`. Для пояснения, рассмотрите криптографический модуль, в котором создается ключ, как модуль генерации ключей.

Любое случайное значение, необходимое модулю генерации ключей, должно быть сгенерировано внутри этого модуля; то есть Генератор Случайных Чисел, который генерирует случайное значение, должен быть реализован внутри криптографического модуля, соответствующего требованиям хотя бы `FIPS 140-2`, который генерирует ключ.

Предпочтительнее использовать аппаратные криптографические модули по сравнению с программными для защиты.

### Распределение

Сгенерированные ключи должны передаваться (если это необходимо) через защищенные каналы и использоваться их связанными криптографическими алгоритмами внутри криптографических модулей, соответствующих требованиям хотя бы `FIPS 140-2`. Для получения дополнительных рекомендаций в этом разделе смотрите `NIST Special Paper 800-133`.

### Хранение

1. Разработчики должны понимать, где криптографические ключи хранятся в приложении. Понимать, на каких устройствах памяти хранятся ключи.
2. Ключи должны быть защищены как в оперативной, так и в постоянной памяти, предпочтительно обрабатываться внутри защищенных криптографических модулей.
3. Ключи никогда не должны храниться в формате открытого текста.
4. Убедитесь, что все ключи хранятся в криптографическом хранилище, таком как [аппаратный модуль безопасности](https://en.wikipedia.org/wiki/Hardware_security_module) (HSM) или изолированная криптографическая служба.
5. Если вы планируете хранить ключи в офлайн-устройствах/базах данных, шифруйте ключи с использованием Ключей Шифрования Ключей (KEKs) перед экспортом ключевых материалов. Длина KEK (и алгоритм) должна быть эквивалентна или превосходить силу защищаемых ключей.
6. Убедитесь, что на ключи применяются защиты целостности в процессе хранения (учтите алгоритмы двойного назначения, поддерживающие шифрование и Код Аутентификации Сообщений (MAC)).
7. Убедитесь, что стандартный код уровня приложения никогда не читает и не использует криптографические ключи и используйте библиотеки управления ключами.
8. Убедитесь, что все операции с ключами выполняются внутри запечатанного хранилища.
9. Все работы должны проводиться в хранилище (такие как доступ к ключу, шифрование, дешифрование, подпись и т.д.).

Для более полного руководства по хранению конфиденциальной информации, такой как ключи, смотрите [Шпаргалку по Управлению Секретами](Secrets_Management_Cheat_Sheet.md).

### Эскроу и Резервное Копирование

Данные, зашифрованные утерянными криптографическими ключами, не подлежат восстановлению. Поэтому крайне важно, чтобы приложение включало возможность безопасного резервного копирования ключей, особенно для приложений, поддерживающих шифрование данных в состоянии покоя для долгосрочных хранилищ данных.

При резервном копировании ключей убедитесь, что база данных, используемая для хранения ключей, зашифрована с использованием модуля, соответствующего требованиям хотя бы `FIPS 140-2`. Иногда полезно использовать эскроу ключевых материалов для расследований и повторного предоставления ключевых материалов пользователям в случае утери или повреждения ключа.

Никогда не используйте эскроу для ключей, используемых для выполнения цифровых подписей, но рассмотрите необходимость использования эскроу для ключей, поддерживающих шифрование. Обычно эскроу может выполняться [Центром сертификации](https://en.wikipedia.org/wiki/Certificate_authority) (CA) или системой управления ключами, которая предоставляет сертификаты и ключи, однако в некоторых случаях необходимо реализовать отдельные API для обеспечения эскроу для приложения.

### Подотчетность и Аудит

Подотчетность включает в себя идентификацию тех, кто имеет доступ к криптографическим ключам или контроль над ними на протяжении всего их жизненного цикла. Подотчетность может быть эффективным инструментом для предотвращения компрометаций ключей и уменьшения последствий компрометаций, когда они обнаружены.

Хотя предпочтительно, чтобы никто из людей не имел возможность видеть ключи, как минимум, система управления ключами должна учитывать всех лиц, которые могут просматривать ключи в открытом тексте.

Кроме того, более сложные системы управления ключами могут учитывать всех лиц, уполномоченных получать доступ или контролировать криптографические ключи, будь то в открытом или зашифрованном виде.

Подотчетность предоставляет три значительных преимущества:

1. Помогает определить, когда могла произойти компрометация и какие лица могли быть вовлечены.
2. Способствует защите от компрометации, поскольку лица с доступом к ключу знают, что их доступ к ключу известен.
3. Полезна при восстановлении после обнаруженной компрометации ключа, так как позволяет узнать, где использовался ключ и какие данные или другие ключи были защищены компрометированным ключом.

Некоторые принципы оказались полезными для обеспечения подотчетности криптографических ключей. Эти принципы могут не применяться ко всем системам или всем типам ключей.

Некоторые принципы, применимые к долгосрочным ключам, контролируемым людьми, включают:

1. Уникальная идентификация ключей.
2. Идентификация пользователя ключа.
3. Идентификация дат и времени использования ключа, а также данных, которые защищены.
4. Идентификация других ключей, которые защищены симметричным или частным ключом.

На системах управления ключами следует проводить два типа аудита:

1. План безопасности и процедуры, разработанные для поддержки плана, должны периодически проверяться, чтобы убедиться, что они продолжают поддерживать Политику Управления Ключами (`NIST SP 800-57 Part 2`).
2. Защитные механизмы должны периодически переоцениваться с точки зрения уровня безопасности, который они обеспечивают и который ожидается в будущем, и того, что механизмы правильно и эффективно поддерживают соответствующие политики.

Необходимо учитывать новые технологические разработки и атаки. Более часто следует проверять действия людей, которые используют, эксплуатируют и обслуживают систему, чтобы убедиться, что они продолжают следовать установленным процедурам безопасности.

Сильные криптографические системы могут быть скомпрометированы небрежными и неподобающими действиями людей. Необычные события должны фиксироваться и рассматриваться как возможные индикаторы попыток атак на систему.

### Компрометация Ключей и Восстановление

Компрометация ключа имеет следующие последствия:

1. В общем случае несанкционированное раскрытие ключа, используемого для обеспечения конфиденциальности (т.е. через шифрование), означает, что вся информация, зашифрованная этим ключом, может быть раскрыта или известна несанкционированным лицам. Раскрытие частного ключа Центра сертификации означает, что злоумышленник может создать поддельные сертификаты и Списки Отменённых Сертификатов (CRL).
2. Компрометация целостности ключа означает, что ключ неверен — либо он был изменён (умышленно или случайно), либо другой ключ был подставлен; это также включает удаление (недоступность) ключа. Замена или изменение ключа, используемого для обеспечения целостности, ставит под сомнение целостность всей информации, защищённой этим ключом. Эта информация могла быть предоставлена или изменена несанкционированным лицом, которое знает ключ. Замена открытого или закрытого ключа, который будет использован (в будущем) для шифрования данных, может позволить несанкционированному лицу (знающему ключ расшифровки) расшифровать данные, зашифрованные с помощью ключа шифрования.
3. Компрометация использования или ассоциации ключа с приложением означает, что ключ может использоваться не по назначению (например, для установления ключей вместо цифровых подписей) или для неправильного приложения, что может привести к компрометации информации, защищённой ключом.
4. Компрометация ассоциации ключа с владельцем или другой сущностью означает, что идентичность другой сущности не может быть подтверждена (т.е. не известно, кто на самом деле эта другая сущность) или что информация не может быть обработана правильно (например, расшифрована с правильным ключом).
5. Компрометация ассоциации ключа с другой информацией означает, что ассоциации нет вообще или ассоциация неверна. Это может вызвать сбои в криптографических услугах, потерю информации или компрометацию безопасности информации. Определённые защитные меры могут быть приняты для минимизации вероятности или последствий компрометации ключа. Это имеет схожий эффект с программами-вымогателями, только вы не можете заплатить выкуп и вернуть ключ.

Обычно включаются следующие процедуры:

1. Ограничение времени, в течение которого симметричный или частный ключ находится в открытом виде.
2. Препятствование людям к просмотру открытых симметричных и частных ключей.
3. Ограничение открытых симметричных и частных ключей физически защищёнными контейнерами. Это включает генераторы ключей, устройства транспортировки ключей, загрузчики ключей, криптографические модули и устройства хранения ключей.
4. Использование проверок целостности для обеспечения того, что целостность ключа или его ассоциация с другими данными не была скомпрометирована. Например, ключи могут быть упакованы (т.е. зашифрованы) таким образом, чтобы несанкционированные изменения в упаковке или ассоциациях были обнаружены.
5. Использование подтверждения ключа (см. NIST SP 800-57 Part 1 Section 4.2.5.5), чтобы помочь обеспечить, что был установлен правильный ключ.
6. Создание системы подотчетности, которая отслеживает каждый доступ к симметричным и частным ключам в открытом виде.
7. Предоставление криптографической проверки целостности ключа (например, с использованием MAC или цифровой подписи).
8. Использование доверенных временных меток для подписанных данных.
9. Уничтожение ключей, как только они больше не нужны.
10. Создание плана восстановления после компрометации, особенно в случае компрометации CA.

План восстановления после компрометации необходим для восстановления криптографических служб в случае компрометации ключа. План восстановления должен быть задокументирован и легко доступен.

План восстановления после компрометации должен содержать:

1. Идентификацию и контактную информацию персонала, которого необходимо уведомить.
2. Идентификацию и контактную информацию персонала, который выполнит действия по восстановлению.
3. Метод повторного назначения ключей.
4. Инвентаризацию всех криптографических ключей и их использования (например, местоположение всех сертификатов в системе).
5. Обучение всего соответствующего персонала по процедурам восстановления.
6. Идентификацию и контактную информацию всего персонала, необходимого для поддержки процедур восстановления.
7. Политики, требующие проверки отзыва ключей (чтобы минимизировать эффект компрометации).
8. Мониторинг операций по повторному назначению ключей (чтобы убедиться, что все необходимые операции выполняются для всех затронутых ключей).
9. Любые другие процедуры восстановления, которые могут включать:
   1. Физическую проверку оборудования.
   2. Идентификацию всей информации, которая могла быть скомпрометирована в результате инцидента.
   3. Идентификацию всех подписей, которые могут быть недействительными из-за компрометации ключа подписи.
   4. Распределение нового ключевого материала, если это необходимо.

### Хранилища Доверия

1. Проектируйте контрольные механизмы для защиты хранилища доверия от внедрения корневых сертификатов третьих сторон. Контроль доступа управляется и применяется на уровне сущностей и приложений.
2. Реализуйте контроль целостности объектов, хранящихся в хранилище доверия.
3. Не допускайте экспорт ключей, хранящихся в хранилище доверия, без аутентификации и авторизации.
4. Установите строгие политики и процедуры для экспорта ключевого материала из приложений в сетевые приложения и другие компоненты.
5. Реализуйте безопасный процесс обновления хранилища доверия.

### Библиотеки Управления Криптографическими Ключами

Используйте только авторитетные криптографические библиотеки, которые хорошо поддерживаются и обновляются, а также тестируются и сертифицируются сторонними организациями (например, `NIST`/`FIPS`).

### Документация

- [Окончательное руководство по основам управления ключами шифрования](https://downloads.townsendsecurity.com/ebooks/EKM-Definitive-Guide.pdf).
- [Практическое руководство по криптографии для разработчиков](https://cryptobook.nakov.com/).

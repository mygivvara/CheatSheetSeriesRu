# Шпаргалка по безопасности для Django REST Framework (DRF)

## Введение

Эта шпаргалка предоставляет основные советы по безопасности для разработчиков, работающих с Django REST Framework (DRF). DRF упрощает разработку API с использованием Django, но требует внимания к мерам безопасности для защиты вашего приложения.

## Настройки

Конфигурация DRF осуществляется через пространство имен `REST_FRAMEWORK`, обычно в файле `settings.py`. Основные настройки включают:

### DEFAULT_AUTHENTICATION_CLASSES

- **Описание**: Указывает классы аутентификации, которые используются для определения аутентифицированных пользователей.
- **По умолчанию**: `'rest_framework.authentication.SessionAuthentication'`, `'rest_framework.authentication.BasicAuthentication'`
- **Рекомендация**: Убедитесь, что в этот список включены соответствующие классы аутентификации для вашего приложения.

### DEFAULT_PERMISSION_CLASSES

- **Описание**: Определяет настройки разрешений по умолчанию для представлений.
- **По умолчанию**: `'rest_framework.permissions.AllowAny'` (что позволяет доступ ко всем)
- **Рекомендация**: Настройте эту настройку, чтобы ограничить доступ по мере необходимости.

### DEFAULT_THROTTLE_CLASSES

- **Описание**: Указывает классы ограничения частоты запросов.
- **По умолчанию**: Пусто (по умолчанию нет ограничения частоты)
- **Рекомендация**: Настройте ограничение частоты, чтобы предотвратить злоупотребления и атаки отказа в обслуживании (DoS).

### DEFAULT_PAGINATION_CLASS

- **Описание**: Определяет класс пагинации для запросов.
- **По умолчанию**: Пагинация отключена.
- **Рекомендация**: Настройте пагинацию, чтобы избежать проблем с отказом в обслуживании (DoS) при большом объеме данных.

## OWASP API Security Top 10

Список [OWASP API Security Top 10](https://owasp.org/www-project-api-security/) представляет собой перечень наиболее критичных рисков безопасности для API, разработанный [Open Web Application Security Project (OWASP)](https://owasp.org/). Он предназначен для помощи организациям в выявлении и приоритизации самых значительных рисков для их API, чтобы можно было внедрить соответствующие меры контроля.

Этот раздел основан на этом списке. Ваш подход к защите веб-API должен начинаться с самого важного риска A1 ниже и двигаться вниз, чтобы гарантировать, что время, затраченное на безопасность, будет потрачено наиболее эффективно и сначала охватит самые важные угрозы, а затем менее значительные.

### API1:2019 Broken Object Level Authorization (Неисправная авторизация на уровне объектов)

При использовании разрешений на уровне объектов:

**ДЕЛАЙТЕ:** Проверьте, что объект может быть доступен пользователю, используя метод `.check_object_permissions(request, obj)`. Пример:

```python
def get_object(self):
    obj = get_object_or_404(self.get_queryset(), pk=self.kwargs["pk"])
    self.check_object_permissions(self.request, obj)
    return obj
```

**НЕ ДЕЛАЙТЕ:** Переопределяйте метод `get_object()`, не проверяя, должен ли запрос иметь доступ к этому объекту.

### API2:2019 Broken User Authentication (Неисправная аутентификация пользователя)

**ДЕЛАЙТЕ:** Используйте значение настройки `DEFAULT_AUTHENTICATION_CLASSES` с правильными классами для вашего проекта.

**ДЕЛАЙТЕ:** Обеспечьте наличие аутентификации на каждом не публичном API-эндпоинте.

**НЕ ДЕЛАЙТЕ:** Переопределяйте класс аутентификации в представлении на основе класса (переменная `authentication_classes`) или функции (декоратор `authentication_classes`), если вы не уверены в изменении и не понимаете его последствия.

### API3:2019 Excessive Data Exposure (Избыточное раскрытие данных)

**ДЕЛАЙТЕ:** Проверьте сериализатор и информацию, которую вы отображаете.

Если сериализатор наследуется от `ModelSerializer`, **НЕ ДЕЛАЙТЕ:** Используйте свойство `exclude` в `Meta`.

**НЕ ДЕЛАЙТЕ:** Отображайте больше информации, чем минимум, необходимый для работы.

### API4:2019 Lack of Resources & Rate Limiting (Отсутствие ограничения ресурсов и частоты запросов)

**ДЕЛАЙТЕ:** Настройте настройку `DEFAULT_THROTTLE_CLASSES`.

**НЕ ДЕЛАЙТЕ:** Переопределяйте класс ограничения частоты в представлении на основе класса (переменная `throttle_classes`) или функции (декоратор `throttle_classes`), если вы не уверены в изменении и не понимаете его последствия.

**ДОПОЛНИТЕЛЬНО:** Если возможно, ограничение частоты запросов также должно выполняться с помощью WAF или аналогичного решения. DRF должен быть последним уровнем ограничения частоты.

### API5:2019 Broken Function Level Authorization (Неисправная авторизация на уровне функций)

**ДЕЛАЙТЕ:** Измените значение по умолчанию (`'rest_framework.permissions.AllowAny'`) настройки `DEFAULT_PERMISSION_CLASSES`.

**НЕ ДЕЛАЙТЕ:** Используйте `rest_framework.permissions.AllowAny`, кроме как для публичных API-эндпоинтов.

**ДЕЛАЙТЕ:** Используйте значение настройки `DEFAULT_PERMISSION_CLASSES` с правильными классами для вашего проекта.

**НЕ ДЕЛАЙТЕ:** Переопределяйте класс авторизации в представлении на основе класса (переменная `permission_classes`) или функции (декоратор `permission_classes`), если вы не уверены в изменении и не понимаете его последствия.

### API6:2019 Mass Assignment (Масс-ассигнование)

При использовании `ModelForms`:

**ДЕЛАЙТЕ:** Используйте `Meta.fields` (подход с белым списком).

**НЕ ДЕЛАЙТЕ:** Используйте `Meta.exclude` (подход с черным списком).

**НЕ ДЕЛАЙТЕ:** Используйте `ModelForms.Meta.fields = "__all__"`

### API7:2019 Security Misconfiguration (Неправильная конфигурация безопасности)

**ДЕЛАЙТЕ:** Установите значения `DEBUG` и `DEBUG_PROPAGATE_EXCEPTIONS` в `False`.

**ДЕЛАЙТЕ:** Установите значение `SECRET_KEY` на случайное значение. Никогда не хардкодьте секреты.

**ДЕЛАЙТЕ:** Иметь повторяемый процесс жесткой настройки, который обеспечивает быструю и легкую развертку правильно настроенной среды.

**ДЕЛАЙТЕ:** Иметь автоматизированный процесс для постоянной оценки эффективности конфигурации и настроек во всех средах.

**ДЕЛАЙТЕ:** Убедитесь, что API доступен только через указанные HTTP-методы. Все другие HTTP-методы должны быть отключены.

**НЕ ДЕЛАЙТЕ:** Используйте стандартные пароли.

### API8:2019 Injection (Внедрение)

**ДЕЛАЙТЕ:** Валидируйте, фильтруйте и очищайте все данные, предоставляемые клиентом, или другие данные, поступающие из интегрированных систем.

#### SQLi

**ДЕЛАЙТЕ:** Используйте параметризованные запросы.

**ПОПРОБУЙТЕ НЕ:** Использовать опасные методы, такие как `raw()`, `extra()` и пользовательский SQL (через `cursor.execute()`).

**НЕ ДЕЛАЙТЕ:** Добавляйте пользовательский ввод в опасные методы (`raw()`, `extra()`, `cursor.execute()`).

#### RCE

**НЕ ДЕЛАЙТЕ:** Добавляйте пользовательский ввод в опасные методы (`eval()`, `exec()` и `execfile()`).

**НЕ ДЕЛАЙТЕ:** Загружайте файлы pickle, контролируемые пользователем. Это включает метод `pandas.read_pickle()`.

**НЕ ДЕЛАЙТЕ:** Загружайте файлы YAML, контролируемые пользователем, используя метод `load()`.

**ДЕЛАЙТЕ:** Используйте `Loader=yaml.SafeLoader` для файлов YAML.

### API9:2019 Improper Assets Management (Неправильное управление активами)

**ДЕЛАЙТЕ:** Иметь инвентаризацию всех хостов API и документировать важные аспекты каждого из них, с акцентом на среду API (например, продакшн, staging, тестирование, разработка), кто должен иметь сетевой доступ к хосту (например, публичный, внутренний, партнеры) и версию API.

**ДЕЛАЙТЕ:** Документируйте все аспекты вашего API, такие как аутентификация, ошибки, перенаправления, политика CORS и конечные точки, включая их параметры, запросы и ответы.

### API10:2019 Insufficient Logging & Monitoring (Недостаточное ведение журналов и мониторинг)

**ДЕЛАЙТЕ:** Логируйте все неудачные попытки аутентификации, отказ в доступе и ошибки проверки ввода с достаточным контекстом пользователя для идентификации подозрительных или вредоносных аккаунтов.

**ДЕЛАЙТЕ:** Соз

давайте журналы в формате, подходящем для использования системой управления журналами, и включайте достаточные детали для идентификации злоумышленника.

**ДЕЛАЙТЕ:** Обращайтесь с журналами как с конфиденциальными данными, и их целостность должна быть гарантирована в состоянии покоя и при передаче.

**ДЕЛАЙТЕ:** Настройте систему мониторинга для постоянного мониторинга инфраструктуры, сети и функционирования API.

**ДЕЛАЙТЕ:** Используйте систему управления информацией и событиями безопасности (SIEM) для агрегирования и управления журналами из всех компонентов стека API и хостов.

**ДЕЛАЙТЕ:** Настройте пользовательские панели инструментов и оповещения, позволяя обнаруживать подозрительную активность и реагировать на нее ранее.

**ДЕЛАЙТЕ:** Установите эффективное мониторинг и оповещение, чтобы подозрительная активность обнаруживалась и на нее реагировали своевременно.

**НЕ ДЕЛАЙТЕ:** Логируйте общие сообщения об ошибках, такие как: Log.Error("Произошла ошибка"); вместо этого логируйте трассировку стека, сообщение об ошибке и идентификатор пользователя, который вызвал ошибку.

**НЕ ДЕЛАЙТЕ:** Логируйте конфиденциальные данные, такие как пароли пользователей, токены API или личную информацию.

## Другие риски безопасности

Ниже приведен список рисков безопасности для API, не обсуждаемых в OWASP API Security Top 10.

### Ошибки бизнес-логики

Любое приложение на любой технологии может содержать ошибки бизнес-логики, которые приводят к проблемам с безопасностью. Ошибки бизнес-логики трудно или невозможно обнаружить с помощью автоматизированных инструментов. Лучшие способы предотвращения ошибок безопасности бизнес-логики включают моделирование угроз, обзор дизайна безопасности, код-ревью, парное программирование и написание модульных тестов.

### Управление секретами

Секреты никогда не должны быть закодированы в коде. Лучшей практикой является использование менеджера секретов. Для получения дополнительной информации ознакомьтесь со [Шпаргалкой по управлению секретами](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html).

## Обновление Django и DRF и процесс обновления зависимостей

Одной из проблем каждого приложения, включая приложения на Python, является то, что зависимости могут содержать уязвимости.

Хорошей практикой является аудит зависимостей, используемых вашим проектом.

В целом, важно иметь процесс обновления зависимостей. Примером процесса может быть определение трех механизмов для запуска обновления:

- Каждый месяц/квартал обновляются зависимости в целом.
- Каждую неделю рассматриваются важные уязвимости в безопасности и, при необходимости, инициируется обновление.
- В ИСКЛЮЧИТЕЛЬНЫХ условиях могут потребоваться экстренные обновления.

Команда безопасности Django предоставляет информацию о [том, как Django раскрывает проблемы безопасности](https://docs.djangoproject.com/en/4.1/internals/security/#how-django-discloses-security-issues).

Наконец, важный аспект при рассмотрении добавления новой зависимости в проект — это "Безопасность библиотеки". Как часто она обновляется? Есть ли известные уязвимости? Есть ли активное сообщество? и т. д. Некоторые инструменты могут помочь в этой задаче (например, [Snyk Advisor](https://snyk.io/advisor/python)).

## Инструменты SAST

Существует несколько отличных инструментов статического анализа безопасности для Python, которые стоит рассмотреть, включая:

- **Bandit** – [Bandit](https://bandit.readthedocs.io/en/latest/) — это инструмент, предназначенный для нахождения общих проблем безопасности в Python. Для этого Bandit обрабатывает каждый файл, строит абстрактное синтаксическое дерево (AST) и запускает соответствующие плагины против узлов AST. После завершения сканирования всех файлов Bandit генерирует отчет. Bandit изначально был разработан в рамках проекта OpenStack Security и позже был перенесен в PyCQA.

- **Semgrep** – [Semgrep](https://semgrep.dev/) — это быстрый, открытый статический анализатор для нахождения ошибок, обнаружения уязвимостей в сторонних зависимостях и соблюдения стандартов кода. Разработан компанией "Return To Corporation" (обычно называемой r2c) и участниками с открытым исходным кодом. Он работает на основе правил, которые могут быть сосредоточены на безопасности, лучших практиках языка или чем-то еще. Создать правило легко, и Semgrep очень мощный. Для Django имеется 29 правил.

- **PyCharm Security** – [Pycharm-security](https://pycharm-security.readthedocs.io/en/latest/index.html) — это плагин для PyCharm или IDE от JetBrains с поддержкой Python. Плагин проверяет код Python на наличие общих уязвимостей в области безопасности и предлагает исправления. Его также можно выполнять из контейнера Docker. Он имеет около 40 проверок, некоторые из которых специфичны для Django.

## Связанные статьи и ссылки

- [Безопасные руководящие принципы для Django REST Framework (DRF)](https://openaccess.uoc.edu/handle/10609/147246)
- [Политики безопасности Django](https://docs.djangoproject.com/en/4.1/internals/security/)
- [Безопасность в Django](https://docs.djangoproject.com/en/4.1/topics/security/)
# Шпаргалка по анализу поверхности атаки

## Что такое анализ поверхности атаки и почему он важен

Эта статья описывает простой и прагматичный способ выполнения анализа поверхности атаки и управления поверхностью атаки приложения. Она предназначена для использования разработчиками для понимания и управления рисками безопасности приложения при его проектировании и изменении, а также специалистами по безопасности приложений, проводящими оценку рисков безопасности. Основное внимание здесь уделяется защите приложения от внешних атак - не учитываются атаки на пользователей или операторов системы (например, внедрение вредоносного ПО, атаки социальной инженерии), и меньше внимания уделяется внутренним угрозам, хотя принципы остаются те же. Внутренняя поверхность атаки, скорее всего, будет отличаться от внешней, и некоторые пользователи могут иметь большой доступ.

Анализ поверхности атаки — это создание карты тех частей системы, которые необходимо проверить и протестировать на наличие уязвимостей в безопасности. Цель анализа поверхности атаки — понять зоны риска в приложении, чтобы разработчики и специалисты по безопасности знали, какие части приложения подвержены атакам, находили способы минимизировать это и замечали, когда и как изменяется поверхность атаки, а также что это означает с точки зрения риска.

Хотя анализ поверхности атаки обычно выполняется архитекторами безопасности и пентестерами, разработчики должны понимать и контролировать поверхность атаки, когда проектируют, строят и изменяют систему.

Анализ поверхности атаки помогает вам:

1. определить, какие функции и какие части системы необходимо проверить/протестировать на наличие уязвимостей в безопасности;
2. определить области кода с высоким уровнем риска, требующие защиты в глубину - какие части системы нужно защищать;
3. определить, когда вы изменили поверхность атаки и необходимо провести оценку угроз.

## Определение поверхности атаки приложения

Поверхность атаки описывает все возможные точки, через которые злоумышленник может проникнуть в систему или вывести из нее данные.

Поверхность атаки приложения:

1. это сумма всех путей для передачи данных/команд в приложение и из него, а также
2. кода, который защищает эти пути (включая подключение ресурсов и аутентификацию, авторизацию, журналирование активности, проверку и кодирование данных);
3. все ценные данные, используемые в приложении, включая секреты и ключи, интеллектуальную собственность, критически важные бизнес-данные, личные данные и персональную информацию (PII), а также
4. кода, который защищает эти данные (включая шифрование и контрольные суммы, аудит доступа, а также меры по обеспечению целостности данных и оперативной безопасности).

Эту модель следует наложить на различные типы пользователей - роли, уровни привилегий, которые могут получить доступ к системе (как авторизованные, так и нет). Сложность возрастает с увеличением числа различных типов пользователей. Важно сосредоточиться на двух крайностях: неавторизованные, анонимные пользователи и высокопривилегированные администраторы (например, администраторы баз данных, системные администраторы).

Группируйте каждый тип точки атаки в группы по риску (внешний или внутренний), назначению, реализации, дизайну и технологии. Затем подсчитайте количество точек атаки каждого типа. Далее выберите несколько случаев для каждого типа. Наконец, сосредоточьте свой обзор/оценку на этих случаях.

С таким подходом вам не нужно понимать каждую конечную точку, чтобы понять поверхность атаки и потенциальный профиль риска системы. Вместо этого вы можете подсчитать общее количество различных типов конечных точек и количество точек каждого типа. Это позволяет вам оценить, что потребуется для оценки риска в масштабе, и вы можете определить, когда профиль риска приложения значительно изменился.

### Микросервисы и облачные приложения

Микросервисные и облачные приложения состоят из множества небольших компонентов, слабо связанных с помощью API и масштабируемых независимо. При оценке поверхности атаки для приложений с таким архитектурным стилем следует уделять приоритетное внимание компонентам, доступным из источника атаки (например, внешнего трафика из Интернета). Такие компоненты могут находиться за прокси-серверами, балансировщиками нагрузки и контроллерами входа, а также могут автоматически масштабироваться без предупреждения.

Инструменты с открытым исходным кодом, такие как [Scope](https://github.com/weaveworks/scope) или [ThreatMapper](https://github.com/deepfence/ThreatMapper) помогают визуализировать поверхность атаки.

## Определение и маппинг поверхности атаки

Вы можете начать создание базового описания поверхности атаки в виде рисунка и заметок. Потратьте несколько часов на изучение документов по проектированию и архитектуре с точки зрения злоумышленника. Просмотрите исходный код и определите различные точки входа/выхода:

- Формы и поля пользовательского интерфейса (UI)
- HTTP-заголовки и cookies
- API
- Файлы
- Базы данных
- Другое локальное хранилище
- Электронная почта или другие виды сообщений
- Аргументы времени выполнения
- ...Ваши точки входа/выхода

Общее количество различных точек атаки легко может исчисляться тысячами или больше. Чтобы сделать это управляемым, разбейте модель на разные типы на основе функции, дизайна и технологии:

- Точки входа для входа/аутентификации
- Административные интерфейсы
- Функции запросов и поиска
- Формы для ввода данных (CRUD)
- Бизнес-процессы
- Транзакционные интерфейсы/AP
- Оперативные команды и интерфейсы мониторинга/API
- Интерфейсы с другими приложениями/системами
- ...Ваши типы

Также необходимо определить ценные данные (например, конфиденциальные, чувствительные, регулируемые) в приложении, опросив разработчиков и пользователей системы, а также путем проверки исходного кода.

Вы также можете создать картину поверхности атаки, просканировав приложение. Для веб-приложений можно использовать такие инструменты, как [OWASP ZAP](https://www.zaproxy.org/), [Arachni](http://arachni-scanner.com/), [Skipfish](http://code.google.com/p/skipfish/) или [w3af](http://w3af.sourceforge.net/),  а также многие коммерческие инструменты или службы динамического тестирования и сканирования уязвимостей, чтобы пройтись по вашему приложению и создать карту его частей, доступных через Интернет. Некоторые межсетевые экраны веб-приложений (WAF) также могут экспортировать модель точек входа приложения.

Проверьте и уточните свое понимание поверхности атаки, пройдя через некоторые основные сценарии использования системы: регистрация и создание профиля пользователя, вход в систему, поиск товара, оформление заказа, изменение заказа и так далее. Следите за потоком управления и данными через систему, смотрите, как информация проверяется и где она хранится, какие ресурсы используются и какие другие системы вовлечены. Между анализом поверхности атаки и [моделированием угроз приложения](https://owasp.org/www-community/Application_Threat_Modeling) существует рекурсивная связь: изменения поверхности атаки должны вызывать моделирование угроз, а моделирование угроз помогает понять поверхность атаки приложения.

Модель поверхности атаки может быть грубой и неполной в начале, особенно если вы ранее не проводили никакой работы по обеспечению безопасности приложения. Заполняйте пробелы по мере углубления анализа безопасности или по мере работы с приложением, когда ваше понимание поверхности атаки улучшится.

## Измерение и оценка поверхности атаки

После создания карты поверхности атаки определите зоны с высоким уровнем риска. Сосредоточьтесь на удаленных точках входа — интерфейсах с внешними системами и Интернетом, особенно там, где система допускает анонимный, публичный доступ.

- Сетевой код, особенно обращенный к интернету
- Веб-формы
- Файлы извне сети
- Интерфейсы с другими системами, совместимые с предыдущими версиями — старые протоколы, иногда старый код и библиотеки, сложно поддерживать и тестировать несколько версий
- Собственные API — протоколы и т. д. — скорее всего, в них есть ошибки в проектировании и реализации
- Код безопасности: все, что связано с криптографией, аутентификацией, авторизацией (контроль доступа) и управлением сессиями

Эти области часто являются наиболее уязвимыми для атак. Затем определите, какие компенсационные меры у вас есть, такие как эксплуатационные меры, например, сетевые и межсетевые экраны приложений, а также системы обнаружения или предотвращения вторжений для защиты вашего приложения.

Майкл Ховард из Microsoft и другие исследователи разработали метод для измерения поверхности атаки приложения и отслеживания изменений этой поверхности с течением времени, называемый [коэффициентом относительной поверхности атаки (RSQ)](https://www.cs.cmu.edu/~wing/publications/Howard-Wing03.pdf). С использованием этого метода вы рассчитываете общий показатель поверхности атаки системы и измеряете этот показатель по мере внесения изменений в систему и в то, как она развернута. Исследователи из Carnegie Mellon на основе этой работы разработали формальный способ расчета [метрики поверхности атаки](https://mlsec.info/pdf/tse11.pdf) для крупных систем, таких как SAP. Они рассчитывают поверхность атаки как сумму всех точек входа и выхода, каналов (различные способы подключения клиентов или внешних систем к системе, включая порты TCP/UDP, конечные точки RPC, именованные каналы...) и ненадежных элементов данных. Затем они применяют коэффициент потенциального ущерба/усилий к этим элементам поверхности атаки, чтобы определить области с высоким уровнем риска.

Обратите внимание, что развертывание нескольких версий приложения, оставление функций, которые больше не используются, на случай, если они понадобятся в будущем, или оставление старых резервных копий и неиспользуемого кода увеличивает поверхность атаки. Контроль исходного кода и надежные методы управления изменениями/конфигурациями должны использоваться для того, чтобы фактически развернутая поверхность атаки как можно ближе соответствовала теоретической.

Резервные копии кода и данных — как онлайн, так и на офлайн-носителях — являются важной, но часто игнорируемой частью поверхности атаки системы. Защита ваших данных и интеллектуальной собственности путем написания безопасного программного обеспечения и повышения устойчивости инфраструктуры будут напрасны, если вы передадите все злоумышленникам, не защищая свои резервные копии.

## Управление поверхностью атаки

Получив базовое представление о поверхности атаки, вы можете использовать его для постепенного выявления и управления рисками в будущем по мере внесения изменений в приложение. Задайте себе следующие вопросы:

- Что изменилось?
- Что вы делаете иначе? (технология, новый подход и т.д.)
- Какие уязвимости могли появиться?

Первая веб-страница, которую вы создаете, значительно открывает поверхность атаки системы и вводит всевозможные новые риски. Если вы добавите еще одно поле на эту страницу или другую подобную веб-страницу, технически вы увеличите поверхность атаки, но не измените существенно профиль риска приложения. Каждое из этих поэтапных изменений — это скорее то же самое, если только вы не следуете новому дизайну или не используете новую платформу.

Если вы добавите новую веб-страницу, которая следует тому же дизайну и использует ту же технологию, что и существующие веб-страницы, легко понять, сколько нужно тестирования безопасности и проверки. Если вы добавляете новый API веб-службы или файл, который может быть загружен из Интернета, у каждого из этих изменений будет другой профиль риска — посмотрите, подходит ли изменение к существующей группе, проверьте, применяются ли существующие средства контроля и защиты. Если вы добавляете что-то, что не попадает в существующую группу, это означает, что вам нужно провести более тщательную оценку риска, чтобы понять, какие уязвимости безопасности вы можете открыть и какие меры защиты нужно внедрить.

Изменения в управлении сессиями, аутентификации и управлении паролями напрямую влияют на поверхность атаки и требуют проверки. Также это относится к изменениям логики авторизации и контроля доступа, особенно к добавлению или изменению определений ролей, добавлению пользователей-администраторов или административных функций с высокими привилегиями. То же самое касается изменений в коде, который обрабатывает шифрование и секреты. Фундаментальные изменения в том, как выполняется проверка данных, и значительные архитектурные изменения в уровнях и отношениях доверия, или фундаментальные изменения в технической архитектуре — замена веб-сервера или платформы базы данных, или изменение операционной системы времени выполнения.

Когда вы добавляете новые типы пользователей, роли или уровни привилегий, вы проводите такой же анализ и оценку риска. Наложите тип доступа на данные и функции и ищите проблемы и несоответствия. Важно понимать модель доступа для приложения, является ли она позитивной (доступ по умолчанию запрещен) или негативной (доступ по умолчанию разрешен). В позитивной модели доступа любые ошибки при определении данных или функций, разрешенных для нового типа пользователя или роли, легко увидеть. В негативной модели доступа нужно быть гораздо более внимательным, чтобы убедиться, что пользователь не получает доступ к данным/функциям, к которым ему не разрешен доступ.

Такую оценку угроз или рисков можно проводить периодически, как часть проектных работ в последовательных/фазных/спиральных/водопадных проектах разработки, или непрерывно и постепенно в Agile/итеративной разработке.

Как правило, поверхность атаки приложения будет увеличиваться со временем по мере добавления большего количества интерфейсов и типов пользователей и интеграции с другими системами. Также стоит искать способы уменьшения размера поверхности атаки, когда это возможно, упрощая модель (например, сокращая количество уровней пользователей или не храня конфиденциальные данные, если в этом нет абсолютной необходимости), отключая неиспользуемые функции и интерфейсы, внедряя эксплуатационные меры, такие как межсетевой экран веб-приложений (WAF) и обнаружение атак в режиме реального времени, специфичных для приложения.

# Шпаргалка по предотвращению LDAP инъекций

## Введение

Протокол легкого доступа к каталогам (LDAP) позволяет приложению удаленно выполнять операции, такие как поиск и изменение записей в каталогах. LDAP-инъекция возникает из-за недостаточной очистки и проверки входных данных, что позволяет злоумышленникам получать доступ к ограниченной информации с помощью сервиса каталога. Для получения общей информации о LDAP посетите [протокол легкого доступа к каталогам (LDAP)](https://www.redhat.com/en/topics/security/what-is-ldap-authentication).

LDAP-инъекция — это атака, используемая для эксплуатации веб-приложений, которые строят LDAP-запросы на основе пользовательского ввода. Когда приложение не очищает входные данные должным образом, возможно изменение LDAP-запросов с использованием техник, схожих с [SQL-инъекцией](https://owasp.org/www-community/attacks/SQL_Injection).

Этот документ сосредоточен на предоставлении четких, простых и практических рекомендаций по предотвращению уязвимостей LDAP-инъекции в ваших приложениях. Атаки LDAP-инъекций распространены из-за двух факторов:

1. Отсутствие безопасных параметризованных интерфейсов LDAP-запросов.
2. Широкое использование LDAP для аутентификации пользователей в системах.

Атаки LDAP-инъекций могут привести к предоставлению разрешений неавторизованным запросам и изменению содержимого внутри дерева LDAP.

Основные методы защиты:

- Экранируйте все переменные с помощью правильной функции кодирования LDAP.
- Используйте фреймворк, который выполняет экранирование автоматически.

Дополнительные методы защиты:

- Принцип наименьших привилегий.
- Проверка входных данных по белому списку.

## Основные методы защиты

### Метод защиты 1: Экранируйте все переменные с помощью правильной функции кодирования LDAP

#### Экранирование Distinguished Name

Основной способ хранения имен в LDAP основан на DN (Distinguished Name). Это можно рассматривать как уникальный идентификатор. Эти идентификаторы иногда используются для доступа к ресурсам, например, к имени пользователя.

DN может выглядеть следующим образом:

`cn=Richard Feynman, ou=Physics Department, dc=Caltech, dc=edu`

или

`uid=inewton, ou=Mathematics Department, dc=Cambridge, dc=com`

Можно использовать белый список для ограничения ввода допустимыми символами. Символы и последовательности символов, которые должны быть исключены из белого списка — включая метасимволы Java Naming and Directory Interface (JNDI) и специальные символы LDAP — перечислены в следующем списке.

[Полный список](https://ldapwiki.com/wiki/Wiki.jsp?page=DN%20Escape%20Values) включает: `\ # + < > , ; " =` и пробелы в начале или в конце строки.

Некоторые "специальные" символы, которые разрешены в Distinguished Names и не требуют экранирования, включают:

```text
* ( ) . & - _ [ ] ` ~ | @ $ % ^ ? : { } ! '
```

#### Экранирование фильтров поиска

Каждый DN указывает на ровно одну запись, которую можно представить себе как строку в РСУБД. Для каждой записи будет одна или несколько атрибутов, аналогичных столбцам в РСУБД. Если вы хотите искать пользователей в LDAP по определённым атрибутам, вы можете сделать это с помощью фильтров поиска.

В фильтре поиска вы можете использовать стандартную булеву логику для получения списка пользователей, соответствующих произвольному ограничению. Фильтры поиска пишутся в польской нотации, то есть префиксной нотации.

Пример:

```text
(&(ou=Physics)(|
(manager=cn=Freeman Dyson,ou=Physics,dc=Caltech,dc=edu)
(manager=cn=Albert Einstein,ou=Physics,dc=Princeton,dc=edu)
))
```

При построении LDAP-запросов в коде приложения вы ДОЛЖНЫ экранировать любые ненадежные данные, добавляемые в LDAP-запрос. Существуют две формы экранирования LDAP: кодирование для LDAP Search и кодирование для LDAP DN (Distinguished Name). Правильное экранирование зависит от того, очищаете ли вы ввод для фильтра поиска или используете DN в качестве учетных данных, похожих на имя пользователя, для доступа к ресурсу.

Некоторые "специальные" символы, которые разрешены в фильтрах поиска и должны быть экранированы, включают:

```text
* ( ) \ NUL
```

Для получения дополнительной информации о экранировании фильтров поиска посетите [RFC4515](https://datatracker.ietf.org/doc/html/rfc4515#section-3).

#### Пример безопасного экранирования в Java

Следующее решение использует белый список для очистки пользовательского ввода, чтобы строка фильтра содержала только допустимые символы. В этом коде `userSN` может содержать только буквы и пробелы, в то время как пароль может содержать только алфавитно-цифровые символы:

```java
// String userSN = "Sherlock Holmes"; // Действительно
// String userPassword = "secret2"; // Действительно
// ... начало LDAPInjection.searchRecord()...
sc.setSearchScope(SearchControls.SUBTREE_SCOPE);
String base = "dc=example,dc=com";

if (!userSN.matches("[\\w\\s]*") || !userPassword.matches("[\\w]*")) {
 throw new IllegalArgumentException("Недопустимый ввод");
}

String filter = "(&(sn = " + userSN + ")(userPassword=" + userPassword + "))";
// ... остальная часть LDAPInjection.searchRecord()... 
```

Когда поле базы данных, такое как пароль, должно включать специальные символы, критически важно обеспечить, чтобы данные хранились в базе данных в очищенной форме и чтобы любой пользовательский ввод был нормализован перед валидацией или сравнением. Использование символов, имеющих специальное значение в JNDI и LDAP, в отсутствие комплексной нормализации и основанных на белом списке процедур не рекомендуется. Специальные символы должны быть преобразованы в очищенные, безопасные значения перед добавлением их в выражение белого списка, по которому будет производиться валидация ввода. Также нормализация пользовательского ввода должна происходить до этапа валидации (источник: [Предотвращение LDAP-инъекции](https://wiki.sei.cmu.edu/confluence/spaces/flyingpdf/pdfpageexport.action?pageId=88487534)).

Для получения дополнительной информации посетите [OWASP ESAPI Java Encoder Project, который включает encodeForLDAP(String) и encodeForDN(String)](https://owasp.org/www-project-java-encoder/).

#### Пример безопасного экранирования в C# .NET

[.NET AntiXSS](https://blogs.msdn.microsoft.com/securitytools/2010/09/30/antixss-4-0-released/) (теперь класс Encoder) имеет функции кодирования LDAP, включая `Encoder.LdapFilterEncode(string)`, `Encoder.LdapDistinguishedNameEncode(string)` и `Encoder.LdapDistinguishedNameEncode(string, bool, bool)`.

`Encoder.LdapFilterEncode` кодирует ввод в соответствии с [RFC4515](https://tools.ietf.org/search/rfc4515), где небезопасные значения преобразуются в `\XX`, где `XX` — это представление небезопасного символа.

`Encoder.LdapDistinguishedNameEncode` кодирует ввод в соответствии с [RFC2253](https://tools.ietf.org/html/rfc2253), где небезопасные символы преобразуются в `#XX`, где `XX` — это представление небезопасного символа, а запятая, плюс, кавычка, косая черта, знак меньше и знак больше экранируются с использованием нотации косой черты (`\X`). Кроме того, пробел или октоторп (`#`) в начале строки ввода экранируются как `\`, а пробел в конце строки также экранируется.

`LdapDistinguishedNameEncode(string, bool, bool)` также предоставляется, чтобы вы могли отключить правила экранирования начального или конечного символа, например, если вы объединяете экранированный фрагмент Distinguished Name в середину полного Distinguished Name.

### Метод защиты 2: Используйте фреймворки, которые автоматически защищают от LDAP-инъекций

#### Безопасный пример .NET

Рекомендуется использовать [LINQ to LDAP](https://www.nuget.org/packages/LinqToLdap/) (для .NET Framework 4.5 или ниже [до обновления](https://github.com/madhatter22/LinqToLdap/issues/31)) в DotNet. Он предоставляет автоматическое кодирование LDAP при построении LDAP-запросов.
Смотрите [файл Readme](https://github.com/madhatter22/LinqToLdap/blob/master/README.md) в репозитории проекта.

## Дополнительные методы защиты

Помимо применения одного из двух основных методов защиты, рекомендуется также применять все дополнительные методы защиты для обеспечения многослойной защиты. Эти дополнительные методы защиты включают:

- **Принцип наименьших привилегий**
- **Проверка входных данных по белому списку**

### Принцип наименьших привилегий

Чтобы минимизировать потенциальный ущерб от успешной атаки LDAP-инъекции, вы должны минимизировать привилегии, назначенные учетной записи LDAP в вашей среде.

### Включение аутентификации Bind

Если протокол LDAP настроен с аутентификацией Bind, злоумышленники не смогут выполнять атаки LDAP-инъекций из-за проверок и авторизаций, которые выполняются по отношению к действительным учетным данным, предоставленным пользователем.
Злоумышленник все еще может обойти аутентификацию Bind через анонимное соединение или используя неаутентифицированный Bind: Anonymous Bind (LDAP) и Unauthenticated Bind (LDAP).

### Проверка входных данных по белому списку

Проверка входных данных может использоваться для обнаружения неавторизованного ввода до того, как он будет передан в LDAP-запрос. Для получения дополнительной информации смотрите [шпаргалку по проверке входных данных](Input_Validation_Cheat_Sheet.md).

## Связанные статьи

- Статья OWASP о [LDAP-инъекциях](https://owasp.org/www-community/attacks/LDAP_Injection).
- Статья [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/) о том, как [тестировать уязвимости LDAP-инъекций](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/06-Testing_for_LDAP_Injection.html).

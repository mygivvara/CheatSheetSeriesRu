# Шпаргалка по загрузке файлов

## Введение

Загрузка файлов становится неотъемлемой частью любого приложения, где пользователи могут загружать свои фотографии, резюме или видео с демонстрацией проекта, над которым они работают. Приложение должно иметь возможность защищать себя от поддельных и вредоносных файлов, чтобы обезопасить как само приложение, так и пользователей.

Вкратце, для реализации безопасной загрузки файлов необходимо соблюдать следующие принципы:

- **Составьте список разрешённых расширений. Разрешайте только безопасные и критически важные для бизнеса расширения.**
    - **Убедитесь, что [проверка ввода](Input_Validation_Cheat_Sheet.md#file-upload-validation) применяется перед проверкой расширений.**
- **Проверяйте тип файла, не доверяйте заголовку [Content-Type](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type), так как он может быть подделан.**
- **Измените имя файла на сгенерированное приложением.**
- **Установите ограничение на длину имени файла. При необходимости ограничьте допустимые символы.**
- **Установите ограничение на размер файла.**
- **Разрешайте загружать файлы только авторизованным пользователям.**
- **Храните файлы на отдельном сервере. Если это невозможно, храните их за пределами корневой директории веб-сервера.**
    - **В случае публичного доступа к файлам используйте обработчик, который сопоставляет внутренние имена файлов (someid -> file.ext).**
- **Пропускайте файл через антивирус или песочницу, если это возможно, чтобы проверить отсутствие вредоносных данных.**
- **Используйте CDR (обезвреживание и реконструкция контента), если применимо (PDF, DOCX и др.).**
- **Убедитесь, что все используемые библиотеки безопасно настроены и регулярно обновляются.**
- **Защитите загрузку файлов от атак [CSRF](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md).**

## Угрозы при загрузке файлов

Чтобы правильно оценить и понять, какие меры безопасности необходимо внедрить, важно знать, с чем вы сталкиваетесь, чтобы защитить свои активы. В следующих разделах будут рассмотрены риски, связанные с функциональностью загрузки файлов.

### Вредоносные файлы

Атакующий может загрузить файл с целью:

1. Эксплуатации уязвимостей в модуле обработки файлов (например, [ImageTrick Exploit](https://imagetragick.com/), [XXE](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_%28XXE%29_Processing)).
2. Использования файла для фишинга (например, формы для приёма резюме).
3. Отправки ZIP-бомб, XML-бомб (также известных как "атака миллиарда смехов") или просто огромных файлов, чтобы заполнить хранилище сервера и повредить его доступность.
4. Перезаписи существующего файла в системе.
5. Внедрения активного контента на стороне клиента (XSS, CSRF и др.), что может поставить под угрозу других пользователей, если файлы доступны публично.

### Публичный доступ к файлам

Если загруженный файл доступен публично, возникают дополнительные угрозы:

1. Публичное раскрытие других файлов.
2. Инициирование атаки DoS путем запроса большого количества файлов. Запросы небольшие, но ответы значительно больше.
3. Файлы с незаконным, оскорбительным или опасным содержимым (например, персональные данные, защищённые авторским правом материалы и т.д.), что может сделать вас хозяином таких вредоносных файлов.

## Защита загрузки файлов

Нет универсального способа проверки пользовательского контента. Внедрение многослойной защиты является ключом к созданию более защищённого процесса загрузки, адаптированного к потребностям и требованиям сервиса. Применение нескольких техник рекомендуется, так как ни одна из них не является достаточной для полной защиты сервиса.

### Проверка расширений

Убедитесь, что проверка выполняется после декодирования имени файла и что установлены правильные фильтры для предотвращения известных обходных путей, таких как:

- Двойные расширения, например, `.jpg.php`, где легко обходится регулярное выражение `\.jpg`.
- Нулевые байты, например, `.php%00.jpg`, где `.jpg` отсекается, и `.php` становится новым расширением.
- Некорректные регулярные выражения, которые плохо протестированы и проверены. Избегайте создания своей логики, если у вас недостаточно знаний по данной теме.

Ссылайтесь на [шпаргалку по проверке ввода](Input_Validation_Cheat_Sheet.md) для правильной обработки и проверки расширений.

#### Список разрешённых расширений

Используйте только _критически важные для бизнеса_ расширения, не разрешая никакие _ненужные_ расширения. Например, если системе требуется:

- загрузка изображений, разрешите один тип, который соответствует бизнес-требованиям;
- загрузка резюме, разрешите расширения `docx` и `pdf`.

Основываясь на потребностях приложения, обеспечьте использование **наименее опасных** и **наиболее низкорисковых** типов файлов.

#### Блокировка расширений

Идентифицируйте потенциально опасные типы файлов и блокируйте расширения, которые могут быть вредоносными для вашего сервиса.

Имейте в виду, что блокировка определённых расширений сама по себе является слабым методом защиты. В статье о [неконтролируемой загрузке файлов](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload) описывается, как злоумышленники могут попытаться обойти такую проверку.

### Проверка Content-Type

_Заголовок Content-Type для загруженных файлов предоставляется пользователем, и, следовательно, не может считаться надёжным, так как его легко подделать. Хотя на него нельзя полагаться для обеспечения безопасности, он предоставляет быструю проверку для предотвращения случайной загрузки файлов с неправильным типом._

Помимо определения расширения загружаемого файла, его MIME-тип может быть проверен для быстрой защиты от простых атак при загрузке файлов.

Это можно сделать предпочтительно с использованием подхода белого списка; в противном случае можно использовать подход чёрного списка.

### Проверка подписи файла

В дополнение к [проверке Content-Type](#content-type-validation) можно проверить и проверить подпись файла, чтобы убедиться, что она соответствует ожидаемому типу файла.

> Это не должно использоваться отдельно, так как обойти такую проверку достаточно просто.

### Очистка имени файла

Имена файлов могут угрожать системе различными способами: использованием недопустимых символов или специальных зарезервированных имён. Для Windows обратитесь к следующему [руководству MSDN](https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file?redirectedfrom=MSDN#naming-conventions). Для более широкого обзора различных файловых систем и их обработки файлов ознакомьтесь со страницей [Wikipedia о именах файлов](https://en.wikipedia.org/wiki/Filename).

Чтобы избежать вышеупомянутых угроз, рекомендуется создавать **случайную строку** в качестве имени файла, например, используя UUID/GUID. Если имя файла требуется для бизнес-задач, необходимо выполнить соответствующую проверку ввода на стороне клиента (например, активный контент, который может привести к XSS и CSRF атакам) и на стороне сервера (например, перезапись или создание специальных файлов). Следует учитывать ограничения длины имени файла в зависимости от системы, которая хранит файлы, так как каждая система имеет свои ограничения по длине имени файла. Если требуется использование пользовательских имён файлов, рекомендуется реализовать следующее:

- Установите максимальную длину имени файла.
- Ограничьте символы допустимым подмножеством, такими как буквы и цифры, дефис, пробелы и точки.
    - Если это невозможно, создайте список запрещённых символов, которые могут представлять опасность для системы и фреймворка, в котором хранятся и используются файлы.

### Проверка содержимого файла

Как упоминалось в разделе [Публичный доступ к файлам](#public-file-retrieval), содержимое файла может включать вредоносные, неуместные или незаконные данные.

В зависимости от ожидаемого типа файла можно применить специальную проверку содержимого:

- Для **изображений** использование техник переписывания изображений устраняет любой вредоносный контент, внедрённый в изображение; это можно сделать через [рандомизацию](https://security.stackexchange.com/a/8625/118367).
- Для **документов Microsoft** использование [Apache POI](https://poi.apache.org/) помогает проверять загруженные документы.
- **ZIP файлы** не рекомендуются, так как они могут содержать все типы файлов, и в них присутствует множество векторов атак.

Служба загрузки файлов должна позволять пользователям сообщать о незаконном содержимом, а правообладателям — о злоупотреблениях.

Если есть достаточные ресурсы, перед публичным доступом к файлам следует проводить их ручную проверку в изолированной среде.

Добавление автоматизации в процесс проверки может оказаться полезным, однако это сложный процесс, который следует тщательно изучить перед внедрением. Некоторые сервисы (например, Virus Total) предоставляют API для сканирования файлов на наличие известных вредоносных хэшей. Некоторые фреймворки могут проверять и валидировать исходный тип содержимого, сопоставляя его с предопределёнными типами файлов, как это реализовано в [библиотеке рисования ASP.NET](https://docs.microsoft.com/en-us/dotnet/api/system.drawing.imaging.imageformat). Будьте осторожны с угрозами утечки данных и сбора информации через публичные сервисы.

### Место хранения файлов

Место, где должны храниться файлы, должно быть выбрано на основе требований безопасности и бизнеса. Следующие пункты расположены в порядке приоритета по безопасности и включают друг друга:

1. Храните файлы на **отдельном хосте**, что позволяет полностью разделить обязанности между приложением, обслуживающим пользователя, и хостом, который обрабатывает загрузку файлов и их хранение.
2. Храните файлы **вне корневой директории веб-сервера**, где доступ разрешён только администраторам.
3. Храните файлы **внутри корневой директории**, но установите для них только права на запись.
   - Если требуется доступ на чтение, необходимо установить соответствующие меры контроля (например, внутренний IP, авторизованный пользователь и т.д.).

Хранение файлов в базе данных является ещё одной техникой. Это иногда используется для автоматических процессов резервного копирования, защиты от атак на файловую систему и решения проблем с правами доступа. Однако это может привести к проблемам с производительностью (в некоторых случаях), соображениям по поводу хранения базы данных и её резервных копий, а также открывает возможность атак типа SQL-инъекций. Этот метод рекомендуется только при наличии в команде администратора баз данных (DBA), и если данный процесс является улучшением по сравнению с хранением файлов на файловой системе.

> Некоторые файлы отправляются по электронной почте или обрабатываются сразу после загрузки и не хранятся на сервере. Важно провести все меры безопасности, описанные в этой шпаргалке, прежде чем совершать любые действия с файлами.

### Пользовательские разрешения

Перед доступом к сервису загрузки файлов должна быть выполнена проверка на двух уровнях для пользователя, который загружает файл:

- Уровень аутентификации
    - Пользователь должен быть зарегистрированным или идентифицируемым, чтобы установить ограничения и лимиты на его возможности загрузки
- Уровень авторизации
    - Пользователь должен обладать соответствующими разрешениями для доступа или изменения файлов

### Разрешения на файловую систему

> Установите разрешения на файлы, следуя принципу минимальных привилегий.

Файлы должны храниться таким образом, чтобы гарантировать:

- Только системные пользователи, которым разрешено, могут читать файлы
- Установлены только необходимые режимы доступа к файлам
    - Если требуется выполнение, рекомендуется перед запуском файла провести его проверку на наличие макросов или скрытых скриптов как лучшую практику безопасности.

### Лимиты загрузки и скачивания

Приложение должно установить правильные ограничения по размеру для сервиса загрузки, чтобы защитить хранилище файлов. Если система будет распаковывать файлы или обрабатывать их, лимит на размер файла должен учитывать размер после распаковки и использовать безопасные методы для расчёта размера ZIP-файлов. Подробнее об этом можно узнать, как [безопасно извлекать файлы из ZipInputStream](https://wiki.sei.cmu.edu/confluence/display/java/IDS04-J.+Safely+extract+files+from+ZipInputStream), поток ввода Java для обработки ZIP-файлов.

Приложение должно также установить правильные ограничения для сервиса скачивания (если доступен), чтобы защитить сервер от атак типа DoS.

## Фрагменты кода на Java

Репозиторий [Document Upload Protection](https://github.com/righettod/document-upload-protection), написанный Домиником для защиты документов определённых типов на Java.

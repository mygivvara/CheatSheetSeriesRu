# Шпаргалка по HTTP Strict Transport Security

## Введение

HTTP [Strict Transport Security](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security) (также называемый **HSTS**) является опциональным расширением безопасности, которое указывается веб-приложением с помощью специального заголовка ответа. Как только поддерживающий браузер получает этот заголовок, он будет предотвращать любые коммуникации, отправляемые по HTTP, к указанному домену, и будет отправлять все коммуникации через HTTPS. Также это предотвращает появление подсказок о переходе по HTTPS в браузерах.

Спецификация была опубликована в конце 2012 года как [RFC 6797](http://tools.ietf.org/html/rfc6797) (HTTP Strict Transport Security (HSTS)) организацией IETF.

## Угрозы

HSTS решает следующие угрозы:

- Пользователь добавляет в закладки или вручную вводит `http://example.com` и подвергается атаке типа "человек посередине"
    - HSTS автоматически перенаправляет HTTP-запросы на HTTPS для целевого домена
- Веб-приложение, которое предназначено для работы исключительно через HTTPS, случайно содержит HTTP-ссылки или предоставляет контент через HTTP
    - HSTS автоматически перенаправляет HTTP-запросы на HTTPS для целевого домена
- Атакующий пытается перехватить трафик от жертвы, используя недействительный сертификат, и надеется, что пользователь примет недействительный сертификат
    - HSTS не позволяет пользователю игнорировать сообщение о недействительном сертификате

## Примеры

Простой пример, используя длительный (1 год = 31536000 секунд) max-age. Этот пример опасен, так как не включает `includeSubDomains`:

`Strict-Transport-Security: max-age=31536000`

Этот пример полезен, если все существующие и будущие субдомены будут работать через HTTPS. Это более безопасный вариант, но он может заблокировать доступ к некоторым страницам, которые могут быть доступны только через HTTP:

`Strict-Transport-Security: max-age=31536000; includeSubDomains`

Этот пример полезен, если все существующие и будущие субдомены будут работать через HTTPS. В этом примере мы устанавливаем очень короткий max-age на случай ошибок при первоначальной настройке:

`Strict-Transport-Security: max-age=86400; includeSubDomains`

**Рекомендуется:**

- Если владелец сайта хочет, чтобы их домен был включен в [список предварительной загрузки HSTS](https://hstspreload.org), поддерживаемый Chrome (и используемый Firefox и Safari), то используйте следующий заголовок.
- Отправка директивы `preload` с вашего сайта может иметь **ПОСТОЯННЫЕ ПОСЛЕДСТВИЯ** и предотвратить доступ пользователей к вашему сайту и его субдоменам, если вам потребуется вернуться к HTTP. Пожалуйста, прочитайте детали на [удаление из предварительной загрузки](https://hstspreload.org/#removal) перед отправкой заголовка с `preload`.

`Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`

Флаг `preload` указывает на согласие владельца сайта на предварительную загрузку их домена. Владелец сайта также должен подать домен в список.

## Проблемы

Владельцы сайтов могут использовать HSTS для идентификации пользователей без использования cookies. Это может привести к значительным утечкам конфиденциальности. Более подробную информацию можно найти [здесь](http://www.leviathansecurity.com/blog/the-double-edged-sword-of-hsts-persistence-and-privacy).

Cookies могут быть изменены с субдоменов, поэтому отсутствие опции `includeSubDomains` позволяет проводить широкий спектр атак, связанных с cookies, которые HSTS в противном случае предотвратил бы, требуя действительный сертификат для субдомена. Установка флага `secure` на все cookies также предотвратит некоторые, но не все, из тех же атак.

## Поддержка браузеров

На сентябрь 2019 года HSTS поддерживается [всеми современными браузерами](https://caniuse.com/#feat=stricttransportsecurity), за исключением Opera Mini.

## Ссылки

- [Проекты Chromium/HSTS](https://www.chromium.org/hsts/)
- [OWASP Руководство по защите TLS](Transport_Layer_Security_Cheat_Sheet.md)
- [sslstrip](https://github.com/moxie0/sslstrip)
- [Серия уроков AppSec - Эпизод 4](https://www.youtube.com/watch?v=zEV3HOuM_Vw)
- [Скрипт Nmap NSE для проверки конфигурации HSTS](https://github.com/icarot/NSE_scripts/blob/master/http-hsts-verify.nse)

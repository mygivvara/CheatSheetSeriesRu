# Шпаргалка по восстановлению пароля

## Введение

Для реализации надлежащей системы управления пользователями системы интегрируют сервис **Восстановление пароля**, который позволяет пользователю запросить сброс пароля.

Хотя эта функция кажется простой и легкой для реализации, она часто является источником уязвимостей, таких как известная атака на [перечисление пользователей](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account.html).

Следующие краткие рекомендации можно использовать в качестве быстрого справочника для защиты сервиса восстановления пароля:

- **Возвращайте согласованное сообщение для существующих и несуществующих учетных записей.**
- **Убедитесь, что время ответа пользователя является одинаковым.**
- **Используйте побочный канал для передачи метода сброса пароля.**
- **Используйте [токены URL](#url-tokens) для самой простой и быстрой реализации.**
- **Убедитесь, что сгенерированные токены или коды:**
    - **Генерируются случайным образом с использованием криптографически безопасного алгоритма.**
    - **Достаточно длинны для защиты от атак методом подбора.**
    - **Хранятся безопасно.**
    - **Однократного использования и истекают через соответствующий период.**
- **Не вносите изменения в учетную запись, пока не будет представлен действительный токен, например, не блокируйте учетную запись.**

Эта шпаргалка сосредоточена на сбросе паролей пользователей. Для получения рекомендаций по сбросу многфакторной аутентификации (MFA) смотрите соответствующий раздел в [Шпаргалке по многфакторной аутентификации](Multifactor_Authentication_Cheat_Sheet.md#resetting-mfa).

## Сервис восстановления пароля

Процесс сброса пароля можно разделить на два основных шага, которые подробно описаны в следующих разделах.

### Запрос на восстановление пароля

Когда пользователь использует сервис восстановления пароля и вводит свое имя пользователя или электронную почту, необходимо следовать следующим рекомендациям для реализации безопасного процесса:

- Возвращайте согласованное сообщение для существующих и несуществующих учетных записей.
- Убедитесь, что ответы возвращаются в согласованное время, чтобы предотвратить атаки на определение существующих учетных записей. Это можно достичь с помощью асинхронных вызовов или гарантией использования одинаковой логики, а не метода быстрого выхода.
- Реализуйте защиту от чрезмерных автоматизированных запросов, таких как ограничение скорости на уровне каждой учетной записи, требование CAPTCHA или другие меры. В противном случае злоумышленник может отправить тысячи запросов на сброс пароля в час для данной учетной записи, заполняя систему получения пользователя (например, электронную почту или SMS) бесполезными запросами.
- Применяйте обычные меры безопасности, такие как [методы предотвращения SQL-инъекций](SQL_Injection_Prevention_Cheat_Sheet.md) и [валидация ввода](Input_Validation_Cheat_Sheet.md).

### Сброс пароля пользователем

После того как пользователь подтвердит свою личность, предоставив токен (отправленный по электронной почте) или код (отправленный по SMS или другим способом), он должен сбросить свой пароль на новый безопасный. Чтобы обеспечить безопасность этого шага, необходимо предпринять следующие меры:

- Пользователь должен подтвердить установленный пароль, введя его дважды.
- Убедитесь, что используется безопасная политика паролей, которая согласуется с остальной частью приложения.
- Обновите и сохраните пароль в соответствии с [безопасными практиками](Password_Storage_Cheat_Sheet.md).
- Отправьте пользователю электронное письмо с уведомлением о сбросе пароля (не отправляйте пароль в письме!).
- После установки нового пароля пользователь должен войти в систему через обычный механизм. Не входите в систему автоматически, так как это добавляет дополнительную сложность к коду аутентификации и управления сеансами и увеличивает вероятность введения уязвимостей.
- Спросите пользователя, хочет ли он аннулировать все свои существующие сеансы, или аннулируйте сеансы автоматически.

## Методы

Для того чтобы предоставить пользователю возможность запросить сброс пароля, вам нужно иметь способ идентификации пользователя или средство связи с ним через побочный канал.

Это можно сделать с помощью следующих методов:

- [Токены URL](#url-tokens).
- [PIN-коды](#pins).
- [Офлайн-методы](#offline-methods).
- [Безопасностные вопросы](#security-questions).

Эти методы можно использовать вместе, чтобы обеспечить более высокий уровень уверенности в том, что пользователь действительно тот, за кого себя выдает. В любом случае вы должны обеспечить, чтобы у пользователя всегда был способ восстановить свою учетную запись, даже если это включает обращение в службу поддержки и подтверждение своей личности сотрудникам.

### Общие практики безопасности

Необходимо применять хорошие практики безопасности для идентификаторов сброса (токенов, кодов, PIN-кодов и т. д.). Некоторые пункты не применимы к [оффлайн-методам](#offline-methods), таким как ограничение срока действия. Все токены и коды должны быть:

- Сгенерированы с использованием [криптографически безопасного генератора случайных чисел](Cryptographic_Storage_Cheat_Sheet.md#secure-random-number-generation).
    - Также можно использовать JSON Web Tokens (JWT) вместо случайных токенов, хотя это может ввести дополнительные уязвимости, такие как те, которые обсуждаются в [Чек-листе по JSON Web Token](JSON_Web_Token_for_Java_Cheat_Sheet.md).
- Достаточной длины для защиты от атак методом подбора.
- Привязаны к конкретному пользователю в базе данных.
- Аннулированы после использования.
- Хранятся безопасно, как обсуждается в [Чек-листе по хранению паролей](Password_Storage_Cheat_Sheet.md).

### Токены URL

Токены URL передаются в строке запроса URL и обычно отправляются пользователю по электронной почте. Основной обзор процесса выглядит следующим образом:

1. Сгенерируйте токен для пользователя и прикрепите его к строке запроса URL.
2. Отправьте этот токен пользователю по электронной почте.
   - Не полагайтесь на заголовок [Host](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host) при создании URL для сброса, чтобы избежать атак [Host Header Injection](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/17-Testing_for_Host_Header_Injection). URL должен быть жестко закодирован или проверен на соответствие списку доверенных доменов.
   - Убедитесь, что URL использует HTTPS.
3. Пользователь получает электронное письмо и переходит по URL с прикрепленным токеном.
   - Убедитесь, что страница сброса пароля добавляет тег [Referrer Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy) со значением `noreferrer`, чтобы избежать [утечки реферера](https://portswigger.net/kb/issues/00500400_cross-domain-referer-leakage).
   - Реализуйте соответствующую защиту, чтобы предотвратить перебор токенов в URL, например, ограничение частоты запросов.
4. При необходимости выполните дополнительные шаги проверки, такие как требование ответа пользователя на [безопасностные вопросы](#security-questions).
5. Позвольте пользователю создать новый пароль и подтвердить его. Убедитесь, что применяется та же политика паролей, что и в остальной части приложения.

*Примечание:* Токены URL могут следовать тому же поведению, что и [PIN-коды](#pins), создавая ограниченную сессию на основе токена. Решение должно быть принято в зависимости от потребностей и опыта разработчика.

### PIN-коды

PIN-коды — это числа (от 6 до 12 цифр), которые отправляются пользователю через побочный канал, такой как SMS.

1. Сгенерируйте PIN-код.
2. Отправьте его пользователю по SMS или другим способом.
   - Разделение PIN-кода пробелами облегчает его чтение и ввод пользователем.
3. Пользователь вводит PIN-код вместе с именем пользователя на странице сброса пароля.
4. Создайте ограниченную сессию на основе этого PIN-кода, которая разрешает пользователю только сброс пароля.
5. Позвольте пользователю создать новый пароль и подтвердить его. Убедитесь, что применяется та же политика паролей, что и в остальной части приложения.

### Офлайн-методы

Офлайн-методы отличаются от других методов тем, что позволяют пользователю сбросить пароль без запроса специального идентификатора (такого как токен или PIN-код) от сервера. Тем не менее, аутентификация по-прежнему должна выполняться сервером, чтобы убедиться, что запрос является законным. Офлайн-методы предоставляют определенный идентификатор либо при регистрации, либо когда пользователь желает его настроить.

Эти идентификаторы должны храниться офлайн и безопасным образом (например, в менеджерах паролей), а сервер должен строго следовать [общим практикам безопасности](#general-security-practices). Некоторые реализации основаны на [аппаратных OTP токенах](Multifactor_Authentication_Cheat_Sheet.md#hardware-otp-tokens), [сертификатах](Multifactor_Authentication_Cheat_Sheet.md#certificates) или других решениях, которые могут использоваться в корпоративной среде. Эти методы не рассматриваются в данном чек-листе.

#### Резервные коды

Резервные коды должны предоставляться пользователю при регистрации, и пользователь должен хранить их офлайн в безопасном месте (например, в менеджере паролей). Некоторые компании, которые реализуют этот метод, это [Google](https://support.google.com/accounts/answer/1187538), [GitHub](https://help.github.com/en/github/authenticating-to-github/recovering-your-account-if-you-lose-your-2fa-credentials) и [Auth0](https://auth0.com/docs/mfa/guides/reset-user-mfa#recovery-codes).

При реализации этого метода следует соблюдать следующие практики:

- Минимальная длина 8 цифр, 12 для повышения безопасности.
- У пользователя должно быть несколько резервных кодов в любой момент времени, чтобы один из них сработал (большинство сервисов предоставляют пользователю десять резервных кодов).
- Должен быть реализован процесс, позволяющий пользователю аннулировать все существующие резервные коды, если они были скомпрометированы третьей стороной.
- Необходимо реализовать ограничение частоты и другие защиты, чтобы предотвратить перебор резервных кодов злоумышленником.

### Безопасностные вопросы

Безопасностные вопросы не следует использовать в качестве единственного механизма для сброса паролей, так как их ответы часто легко угадываются или могут быть получены злоумышленниками. Тем не менее, они могут предоставить дополнительный уровень безопасности, когда используются в сочетании с другими методами, обсужденными в этом чек-листе. Если вы решите использовать их, убедитесь, что выбраны безопасные вопросы, как обсуждается в [Шпаргалке по выбору и использованию контрольных вопросов](Choosing_and_Using_Security_Questions_Cheat_Sheet.md).

## Блокировка учетных записей

Учетные записи не следует блокировать в ответ на атаку на забытый пароль, так как это может быть использовано для отказа в доступе пользователям с известными именами пользователей. Для получения дополнительной информации о блокировке учетных записей смотрите [Шпаргалку по аутентификации](Authentication_Cheat_Sheet.md).

# Шпаргалка по предотвращению вброса учётных данных

## Введение

В этой шпаргалке рассматриваются средства защиты от двух распространенных типов атак, связанных с аутентификацией: вброс учетных данных и распыление паролей. Хотя это отдельные атаки, во многих случаях средства защиты от них одинаковы, и они также эффективны для защиты от атак перебора.  Ниже приводится краткое описание этих различных атак:

| Тип атаки | Описание |
|-------------|-------------|
| Brute Force | Проверка нескольких паролей из словаря или другого источника против одной учетной записи. |
| Credential Stuffing | Проверка пар имя пользователя/пароль, полученных в результате взлома другого сайта. |
| Проверка паролей | Проверка одного слабого пароля против большого количества различных учетных записей.

## Многофакторная аутентификация

[Многофакторная аутентификация (MFA)](Multifactor_Authentication_Cheat_Sheet.md) - это, безусловно, лучшая защита от большинства атак, связанных с паролями, включая вброс учетных данных и подбор паролей. Анализ Microsoft показывает, что она остановила бы [99,9% компрометаций учетных записей](https://techcommunity.microsoft.com/t5/Azure-Active-Directory-Identity/Your-Pa-word-doesn-t-matter/ba-p/731984). Поэтому ее следует внедрять везде, где это возможно. Исторически, в зависимости от аудитории приложения, принудительное использование MFA могло быть нецелесообразным или невыполнимым, однако с учетом того, что современные браузеры и мобильные устройства теперь поддерживают FIDO2 Passkeys и другие формы MFA, это вполне достижимо для большинства случаев использования.

Чтобы сбалансировать безопасность и удобство использования, многофакторную аутентификацию можно сочетать с другими методами, требующими введения второго фактора только в определенных обстоятельствах, когда есть основания подозревать, что попытка входа в систему может быть нелегитимной, например, при входе в систему с сайта:

- Новый браузер/устройство или IP-адрес.
- Необычная страна или место.
- Определенные страны, которые считаются недоверенными или обычно не содержат пользователей службы.
- IP-адрес, который фигурирует в известных списках отрицания или связан с сервисами анонимизации, такими как прокси- или VPN-сервисы.
- IP-адрес, который пытался войти в несколько учетных записей.
- Попытка входа в систему, которая кажется заскриптованной или предпринятой ботом, а не человеком (например, большое количество входов в систему с одного IP-адреса или подсети).

Или же организация может решить потребовать MFA в виде "ступенчатой" аутентификации для вышеупомянутых сценариев во время сеанса, совмещенного с запросом на выполнение действий с высоким риском, например:

- Крупные валютные операции
- Привилегированные или административные изменения конфигурации

Кроме того, для корпоративных приложений в список разрешений можно добавить известные доверенные диапазоны IP-адресов, чтобы не требовать MFA при подключении пользователей из этих диапазонов.

## Альтернативная защита

Если реализовать MFA невозможно, существует множество альтернативных средств защиты, которые можно использовать для защиты от подбора и распыления паролей. В отдельности ни один из них не является столь же эффективным, как MFA, однако многоуровневая защита может обеспечить разумную степень защиты. Во многих случаях эти механизмы также защищают от атак методом перебора или распыления паролей.

Если приложение имеет несколько ролей пользователей, может быть целесообразно реализовать различные средства защиты для разных ролей. Например, может быть нецелесообразно внедрять MFA для всех пользователей, но можно потребовать, чтобы все администраторы использовали его.

## Глубинная защита и метрики

Несмотря на то что это не конкретная техника, важно реализовать защиту, учитывающую последствия поражения или иного отказа отдельных средств защиты.  Например, защитные средства на стороне клиента, такие как отпечатки устройства или вызовы JavaScript, могут быть подделаны или обойдены, и для учета этого должны быть реализованы другие уровни защиты.

Кроме того, каждая система защиты должна генерировать метрики объема атак для использования в качестве детективного механизма. В идеале метрики должны включать как обнаруженные, так и устраненные атаки и позволять фильтровать их по таким полям, как IP-адрес.  Мониторинг и отчетность по этим показателям могут выявить сбои в защите или наличие неопознанных атак, а также влияние новых или улучшенных средств защиты.

Наконец, если администрирование различных защитных систем осуществляется несколькими командами, следует позаботиться об обеспечении связи и координации действий, когда отдельные команды выполняют обслуживание, развертывание или другие изменения отдельных защитных систем.

### Вторичные пароли, PIN-коды и вопросы безопасности

Помимо требования ввести пароль при аутентификации, пользователям также может быть предложено предоставить дополнительную информацию о безопасности, например:

- PIN-код
- Определенные символы из вторичного пароля или запоминающегося слова
- Ответы на [вопросы по безопасности](Choosing_and_Using_Security_Questions_Cheat_Sheet.md)

Следует подчеркнуть, что это **не** представляет собой многофакторную аутентификацию (поскольку оба фактора одинаковы - это то, что вы знаете). Тем не менее, она может обеспечить полезный уровень защиты от вброса и распыления паролей в тех случаях, когда невозможно реализовать надлежащую MFA.

### CAPTCHA

Требование к пользователю решить "Полностью автоматизированный публичный тест Тьюринга для различения компьютеров и людей" (CAPTCHA) или аналогичную головоломку при каждой попытке входа в систему может помочь выявить автоматические/бот-атаки и предотвратить автоматические попытки входа в систему, а также замедлить атаки на вбивание учетных данных или распыление паролей.  Однако CAPTCHA не идеальны, и во многих случаях существуют инструменты или сервисы, которые можно использовать для их взлома с достаточно высоким процентом успеха.  Мониторинг количества решений CAPTCHA может помочь выявить воздействие на добросовестных пользователей, а также автоматизированные технологии взлома CAPTCHA, о чем может свидетельствовать аномально высокое количество решений.

Для повышения удобства использования может быть желательно требовать от пользователя решения CAPTCHA только в том случае, если запрос на вход в систему считается подозрительным или высокорискованным, используя те же критерии, которые обсуждались в разделе MFA.

### Блокирование IP адресов и 

Блокирование IP-адресов может быть достаточным для пресечения менее сложных атак, но не должно использоваться в качестве основной защиты из-за легкости обхода.  Более эффективным является поэтапный ответ на злоупотребления, который использует несколько защитных мер в зависимости от различных факторов атаки.

Любой процесс или решение по смягчению последствий (включая блокировку и CAPTCHA) трафика с IP-адреса для вброса учетных данных должны учитывать множество сценариев злоупотреблений, а не полагаться на единственный предсказуемый предел объема.  Следует учитывать короткие (т. е. всплески) и длительные периоды времени, а также большой объем запросов и случаи, когда один IP-адрес, вероятно, совместно с _многими_ другими IP-адресами, генерирует небольшой, но постоянный объем трафика.  Кроме того, при принятии решений о смягчении последствий следует учитывать такие факторы, как классификация IP-адресов (например, жилые и хостинговые) и геолокация.  Эти факторы могут быть использованы для повышения или понижения порогов смягчения, чтобы уменьшить потенциальное воздействие на легитимных пользователей или более активно бороться со злоупотреблениями, исходящими из аномальных источников.  Меры смягчения, особенно блокировка IP-адреса, должны быть временными, и должны быть предусмотрены процессы, позволяющие выводить IP-адрес из состояния смягчения по мере снижения или прекращения злоупотреблений.

Многие наборы инструментов для вброса учетных данных, такие как [Sentry MBA](https://federalnewsnetwork.com/wp-content/uploads/2020/06/Shape-Threat-Research-Automating-Cybercrime-with-SentryMBA.pdf), предлагают встроенное использование прокси-сетей для распределения запросов по большому количеству уникальных IP-адресов.  Это может помочь преодолеть блокировку IP-списков и ограничение скорости, поскольку объем запросов на один IP-адрес может оставаться относительно низким даже при большом количестве атак.  Корреляция трафика аутентификации с данными о прокси и аналогичных IP-адресах, а также с диапазонами IP-адресов хостинг-провайдеров может помочь выявить высокораспределенные атаки на вброс учетных данных, а также послужить триггером для смягчения последствий.  Например, каждый запрос, исходящий от хостинг-провайдера, может быть обязан решить CAPTCHA.

Существуют как публичные, так и коммерческие источники информации и классификации IP-адресов, которые можно использовать в качестве источников данных для этой цели.  Кроме того, некоторые хостинг-провайдеры публикуют свое собственное пространство IP-адресов, например [AWS](https://docs.aws.amazon.com/vpc/latest/userguide/aws-ip-ranges.html).

Помимо блокировки сетевых подключений, рассмотрите возможность хранения истории проверки подлинности IP-адресов учетной записи.  В случае добавления недавнего IP-адреса в список блокировки или смягчения последствий, возможно, будет уместно заблокировать учетную запись и уведомить пользователя.

### Отпечатки устройств

Помимо IP-адреса, существует ряд различных факторов, которые могут быть использованы для попытки отпечатка устройства. Некоторые из них сервер может получить пассивно из HTTP-заголовков (в частности, заголовка "User-Agent"), в том числе:

- Операционная система и версия
- Браузер и его версия
- Язык

С помощью JavaScript можно получить доступ к гораздо большему количеству информации, например:

- Разрешение экрана
- Установленные шрифты
- Установленные плагины для браузера

Используя эти различные атрибуты, можно создать отпечаток устройства. Этот отпечаток может быть сопоставлен с любым браузером, пытающимся войти в учетную запись, и если он не совпадает, то пользователю может быть предложено пройти дополнительную аутентификацию. У многих пользователей есть несколько устройств или браузеров, которые они используют, поэтому нецелесообразно просто блокировать попытки, не соответствующие существующим отпечаткам, однако обычно определяют процесс, позволяющий пользователям или клиентам просматривать историю своих устройств и управлять запомненными устройствами.  Кроме того, эти атрибуты могут использоваться для обнаружения аномальной активности, например, устройства, на котором установлена старая версия ОС или браузера.

Библиотека JavaScript [fingerprintjs2](https://github.com/Valve/fingerprintjs2) может быть использована для проведения фингерпринтинга на стороне клиента.

Следует отметить, что поскольку вся эта информация предоставляется клиентом, она потенциально может быть подделана злоумышленником. В некоторых случаях подмена этих атрибутов тривиальна (например, заголовок "User-Agent"), но в других случаях модифицировать эти атрибуты может быть сложнее.

### Фингерпринтинг соединений

Как и в случае с отпечатками устройств, существует множество методов отпечатков для сетевых соединений.  Некоторые примеры включают [JA3](https://github.com/salesforce/ja3), отпечатки HTTP/2 и порядок заголовков HTTP.  Поскольку эти методы обычно фокусируются на способе установления соединения, отпечатки соединений могут давать более точные результаты, чем другие средства защиты, которые полагаются на индикатор, например IP-адрес, или данные запроса, например строку агента пользователя.

Отпечатки соединений также могут использоваться в сочетании с другими средствами защиты для проверки правдивости запроса на аутентификацию.  Например, если заголовок агента пользователя и отпечаток устройства указывают на мобильное устройство, а отпечаток соединения указывает на сценарий Python, запрос, скорее всего, подозрителен.

### Требуйте непредсказуемые имена пользователей

Атаки на вброс учетных данных основаны не только на повторном использовании паролей на разных сайтах, но и на повторном использовании имен пользователей. Значительное число веб-сайтов используют адрес электронной почты в качестве имени пользователя, а поскольку у большинства пользователей есть один адрес электронной почты, который они используют для всех своих учетных записей, это делает комбинацию адреса электронной почты и пароля очень эффективной для атак на вбивание учетных данных.

Требование к пользователям создавать собственное имя пользователя при регистрации на сайте усложняет злоумышленникам задачу получения достоверных пар имени пользователя и пароля для подстановки учетных данных, поскольку многие из доступных списков учетных данных включают только адреса электронной почты. Предоставление пользователю сгенерированного имени пользователя может обеспечить более высокую степень защиты (поскольку пользователи, скорее всего, будут выбирать одно и то же имя пользователя на большинстве веб-сайтов), однако оно неудобно для пользователя. Кроме того, необходимо позаботиться о том, чтобы сгенерированное имя пользователя не было предсказуемым (например, основанным на полном имени пользователя или последовательных цифровых идентификаторах), так как это может облегчить перечисление действительных имен пользователей для атаки с использованием пароля.

### Многоступенчатые процессы входа в систему

Большинство готовых инструментов рассчитаны на одноэтапный процесс входа в систему, когда учетные данные отправляются на сервер, а в ответе указывается, была ли попытка входа успешной. Добавление дополнительных шагов к этому процессу, например, требование последовательного ввода имени пользователя и пароля или получение пользователем случайного [CSRF Token](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md) перед входом в систему, несколько усложняет атаку и удваивает количество запросов, которые должен сделать злоумышленник.

Однако при многоступенчатых процессах входа в систему следует помнить, что они не способствуют [перечислению пользователей] (Authentication_Cheat_Sheet.md).  Перечисление пользователей перед атакой на вброс учетных данных может привести к тому, что атаку будет сложнее идентифицировать, а объем запросов будет меньше.

### Требуйте JavaScript и блокируйте Headless браузеры

Большинство инструментов, используемых для подобных атак, выполняют прямые POST-запросы к серверу и читают ответы, но не загружают и не выполняют содержащийся в них JavaScript. Требуя от злоумышленника оценить JavaScript в ответе (например, для генерации валидного токена, который должен быть отправлен вместе с запросом), это вынуждает его либо использовать настоящий браузер с фреймворком автоматизации, таким как Selenium или Headless Chrome, либо реализовать разбор JavaScript с помощью другого инструмента, такого как PhantomJS. Кроме того, существует ряд техник, которые могут быть использованы для идентификации [Headless Chrome](https://antoinevastel.com/bot%20detection/2018/01/17/detect-chrome-headless-v2.html) или [PhantomJS](https://blog.shapesecurity.com/2015/01/22/detecting-phantomjs-based-visitors/).

Обратите внимание, что блокирование посетителей, у которых отключен JavaScript, снизит доступность сайта, особенно для посетителей, использующих программы для чтения с экрана. В некоторых юрисдикциях это может быть нарушением законодательства о равноправии.

### Деградация

Более агрессивная защита от вброса учетных данных заключается в применении мер, которые увеличивают время, необходимое для завершения атаки.  Это может включать постепенное увеличение сложности JavaScript, который должен быть оценен, введение длительных периодов ожидания перед ответом на запросы, возвращение слишком больших HTML-активов или возвращение произвольных сообщений об ошибках.

Из-за их потенциального негативного влияния на легитимных пользователей к этому типу защиты следует относиться с большой осторожностью, хотя он может быть необходим для борьбы с более сложными атаками, связанными с вбросом учетных данных.

### Выявление утечки паролей

Должно быть реализовано положение (2.1.7) [ASVS v4.0 Password Security Requirements](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x11-V2-Authentication.md#v21-password-security-requirements) о проверке наличия новых паролей в наборах данных взломанных паролей.

Существуют как коммерческие, так и бесплатные сервисы, которые могут быть полезны для проверки паролей, присутствовавших в предыдущих взломах.  Известным бесплатным сервисом для этого является [Pwned Passwords](https://haveibeenpwned.com/Passwords). Вы можете разместить копию приложения у себя или воспользоваться [API](https://haveibeenpwned.com/API/v2#PwnedPasswords).

### Уведомляйте пользователей о необычных событиях безопасности

При обнаружении подозрительной или необычной активности может быть целесообразно уведомить или предупредить пользователя. Однако следует позаботиться о том, чтобы пользователь не был перегружен большим количеством неважных для него уведомлений, иначе он просто начнет их игнорировать или удалять.  Кроме того, из-за частого повторного использования паролей на нескольких сайтах следует рассмотреть возможность того, что учетная запись электронной почты пользователя также была взломана.

Например, обычно не следует уведомлять пользователя о том, что была попытка войти в его учетную запись с неправильным паролем. Однако если была попытка войти в систему с правильным паролем, но при этом последующая проверка MFA не удалась, пользователя следует уведомить, чтобы он мог сменить пароль.  Впоследствии, если пользователь запрашивает несколько сбросов пароля с разных устройств или IP-адресов, может быть целесообразно предотвратить дальнейший доступ к учетной записи до дальнейших процессов проверки пользователя.

Подробности, связанные с текущими или недавними входами в систему, также должны быть видны пользователю. Например, при входе в приложение пользователю может быть показана дата, время и место предыдущей попытки входа. Кроме того, если приложение поддерживает одновременные сеансы, пользователь должен иметь возможность просмотреть список всех активных сеансов и прервать все сеансы, которые не являются законными.

## Ссылки

- [OWASP Credential Stuffing Article](https://owasp.org/www-community/attacks/Credential_stuffing)
- [OWASP Automated Threats to Web Applications](https://owasp.org/www-project-automated-threats-to-web-applications/)
- Проект: [OAT-008 Credential Stuffing](https://owasp.org/www-community/attacks/Credential_stuffing), которая является одной из 20 определенных угроз в [OWASP Automated Threat Handbook](https://owasp.org/www-pdf-archive/Automated-threat-handbook.pdf), подготовленном этим проектом.

# Шпаргалка по безопасности базы данных

## Введение

Эта шпаргалка предоставляет рекомендации по безопасной настройке SQL и NoSQL баз данных. Она предназначена для разработчиков приложений, если они несут ответственность за управление базами данных. Для получения информации о защите от атак с использованием SQL-инъекций, см. [Шпаргалку по предотвращению SQL-инъекций](SQL_Injection_Prevention_Cheat_Sheet.md).

## Защита бекенд базы данных

Бекенд базы данных приложения должен быть изолирован от других серверов и подключаться только к минимальному количеству хостов. Эта задача зависит от архитектуры системы и сети. Рассмотрите следующие предложения:

- Отключение сетевого (TCP) доступа и требование, чтобы весь доступ осуществлялся через локальный файл сокета или именованный канал.
- Настройка базы данных для привязки только к localhost.
- Ограничение доступа к сетевому порту для определённых хостов с помощью правил брандмауэра.
- Размещение сервера базы данных в отдельной DMZ, изолированной от сервера приложений.

Аналогичные меры защиты должны применяться к любым веб-инструментам управления базой данных, таким как phpMyAdmin.

Когда приложение работает на ненадёжной системе (например, толстый клиент), оно всегда должно подключаться к бекенду через API, который может обеспечить контроль доступа и ограничения. Прямые подключения с толстого клиента к базе данных **никогда** не должны осуществляться.

### Реализация защиты транспортного уровня

Большинство баз данных по умолчанию используют нешифрованные сетевые соединения, хотя некоторые из них шифруют начальную аутентификацию (например, Microsoft SQL Server). Даже если начальная аутентификация шифруется, остальной трафик передаётся в открытом виде, что может привести к утечке конфиденциальной информации. Для предотвращения передачи нешифрованного трафика выполните следующие шаги:

- Настройте базу данных на прием только зашифрованных соединений.
- Установите доверенный цифровой сертификат на сервере.
- Настройте клиентское приложение для использования TLSv1.2+ с современными шифрами (например, AES-GCM или ChaCha20).
- Убедитесь, что клиентское приложение проверяет правильность цифрового сертификата.

Дополнительные рекомендации по настройке TLS можно найти в [Шпаргалке по безопасности транспортного уровня](Transport_Layer_Security_Cheat_Sheet.md).

## Настройка безопасной аутентификации

База данных всегда должна требовать аутентификацию, включая подключения с локального сервера. Аккаунты базы данных должны:

- Быть защищены сильными и уникальными паролями.
- Использоваться только одним приложением или сервисом.
- Настраиваться с минимальными правами, как обсуждается в разделе [Создание безопасных разрешений](#создание-безопасных-разрешений).

Как и в любой системе с учётными записями пользователей, следует применять стандартные процессы управления учётными записями, включая:

- Регулярные проверки аккаунтов, чтобы убедиться в их необходимости.
- Регулярные проверки разрешений.
- Удаление учётных записей при отключении приложения.
- Изменение паролей при увольнении сотрудников или при подозрении на их компрометацию.

Для Microsoft SQL Server рассмотрите возможность использования [Windows или интегрированной аутентификации](https://docs.microsoft.com/ru-ru/dotnet/framework/data/adonet/sql/authentication-in-sql-server), которая использует существующие учётные записи Windows вместо учётных записей SQL Server. Это также избавляет от необходимости хранить учетные данные в приложении, так как оно подключится, используя учётные данные пользователя Windows. Плагин [Windows Native Authentication Plugins](https://dev.mysql.com/doc/connector-net/en/connector-net-programming-authentication-windows-native.html) предоставляет аналогичную функциональность для MySQL.

### Безопасное хранение учетных данных базы данных

Учетные данные базы данных никогда не должны храниться в исходном коде приложения, особенно в незашифрованном виде. Вместо этого их следует хранить в конфигурационном файле, который:

- Находится за пределами корневого каталога веб-сайта.
- Имеет соответствующие разрешения, чтобы его мог читать только необходимый пользователь (или пользователи).
- Не добавляется в репозиторий исходного кода.

По возможности эти учетные данные также должны быть зашифрованы или защищены другими средствами, такими как доступная в [ASP.NET](https://docs.microsoft.com/ru-ru/dotnet/framework/data/adonet/connection-strings-and-configuration-files#encrypting-configuration-file-sections-using-protected-configuration) шифровка в `web.config`.

## Создание безопасных разрешений

При назначении разрешений учетным записям пользователей базы данных разработчики должны следовать принципу наименьших привилегий (т. е. учётные записи должны иметь только минимальные права, необходимые для работы приложения). Этот принцип можно применять на нескольких уровнях в зависимости от функциональности базы данных. В любом окружении можно выполнить следующее:

- Не используйте встроенные учётные записи `root`, `sa` или `SYS`.
- Не предоставляйте учётной записи административные права на экземпляр базы данных.
- Убедитесь, что учётная запись может подключаться только с разрешённых хостов, таких как `localhost` или адрес сервера приложения.
- Учётная запись должна иметь доступ только к тем базам данных, которые ей необходимы. В средах разработки, тестирования и продакшена должны использоваться отдельные базы данных и учетные записи.
- Предоставляйте только необходимые права на базы данных. Большинству приложений требуются только права на `SELECT`, `UPDATE` и `DELETE`. Учетная запись не должна быть владельцем базы данных, так как это может привести к уязвимостям, связанным с повышением привилегий.
- Избегайте использования ссылок на базы данных или связанных серверов. Если они необходимы, используйте учетную запись с минимальными правами доступа к необходимым базам данных, таблицам и системным привилегиям.

Большинство критически важных приложений применяют разрешения на более детализированных уровнях, таких как:

- Разрешения на уровне таблиц.
- Разрешения на уровне столбцов.
- Разрешения на уровне строк.
- Ограничение доступа к основным таблицам и требование использовать доступ через ограниченные [представления](<https://ru.wikipedia.org/wiki/Представление_(SQL)>).

## Конфигурация и усиление безопасности базы данных

Операционная система сервера базы данных должна быть усилена с использованием надёжных базовых конфигураций, таких как [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks/) или [Microsoft Security Baselines](https://docs.microsoft.com/ru-ru/windows/security/threat-protection/windows-security-baselines).

Приложение базы данных также должно быть правильно настроено и защищено. Следующие принципы применимы ко всем базам данных:

- Установите необходимые обновления безопасности и патчи.
- Настройте службы базы данных для работы от учётной записи с минимальными правами.
- Удалите любые стандартные учётные записи и базы данных.
- Храните [журналы транзакций](https://ru.wikipedia.org/wiki/Журнал_транзакций) на отдельном диске от основных файлов базы данных.
- Настройте регулярное резервное копирование базы данных. Убедитесь, что резервные копии защищены соответствующими разрешениями и, по возможности, зашифрованы.

Ниже приведены дополнительные рекомендации для конкретных баз данных в дополнение к общим рекомендациям.

### Усиление безопасности Microsoft SQL Server

- Отключите `xp_cmdshell`, `xp_dirtree` и другие хранимые процедуры, которые не требуются.
- Отключите выполнение CLR (Common Language Runtime).
- Отключите службу SQL Browser.
- Отключите [Mixed Mode Authentication](https://docs.microsoft.com/ru-ru/sql/relational-databases/security/choose-an-authentication-mode?view=sql-server-ver15), если она не требуется.
- Убедитесь, что примеры баз данных [Northwind и AdventureWorks](https://docs.microsoft.com/ru-ru/dotnet/framework/data/adonet/sql/linq/downloading-sample-databases) удалены.
- См. статьи Microsoft по [защите SQL Server](https://docs.microsoft.com/ru-ru/sql/relational-databases/security/securing-sql-server).

### Усиление безопасности MySQL или MariaDB

- Запустите скрипт `mysql_secure_installation` для удаления стандартных баз данных и учетных записей.
- Отключите привилегию [FILE](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html#priv_file) для всех пользователей, чтобы предотвратить чтение или запись файлов.
- См. руководство по безопасности [Oracle MySQL](https://dev.mysql.com/doc/refman/8.0/en/security-guidelines.html) и [MariaDB](https://mariadb.com/ru/library/securing-mariadb/).

### Усиление безопасности PostgreSQL

- См. [Документацию по настройке и эксплуатации PostgreSQL](https://www.postgresql.org/docs/current/runtime.html) и более старую [документацию по безопасности](https://www.postgresql.org/docs/7.0/security.htm).

### MongoDB

- См. [контрольный список безопасности MongoDB](https://docs.mongodb.com/manual/administration/security-checklist/).

### Redis

- См. [руководство по безопасности Redis](https://redis.io/topics/security).
